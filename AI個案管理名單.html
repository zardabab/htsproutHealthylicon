<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å€‹æ¡ˆç®¡ç†åå–®</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f4f8 100%);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            margin-bottom: 1.5rem;
        }
        
        .page-header h1 {
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196f3;
            border-radius: 10px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.15);
            margin-bottom: 1.5rem;
        }
        
        .info-box i {
            color: #1976d2;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1.2rem 1rem;
            font-size: 0.9rem;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
            position: relative;
            border-bottom: 3px solid #be185d;
        }
        
        .table thead th:first-child {
            border-top-left-radius: 10px;
        }
        
        .table thead th:last-child {
            border-top-right-radius: 10px;
        }
        
        .table thead th i {
            color: #fce7f3;
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .status-btn {
            margin-right: 5px;
            margin-bottom: 5px;
            position: relative;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .status-btn i.fa-check {
            display: none;
            margin-left: 5px;
        }
        
        .status-btn.completed i.fa-check {
            display: inline-block;
            animation: checkPop 0.3s ease;
        }
        
        @keyframes checkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .status-btn.completed {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        /* ç‹€æ³æ¨™ç±¤é¡è‰² */
        .badge-condition {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        
        .condition-è„†éª¨ {
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            color: #92400e;
            border: 2px solid #fbbf24;
        }
        
        .condition-ç¥ç¶“æå‚· {
            background: linear-gradient(135deg, #ddd6fe 0%, #a78bfa 100%);
            color: #5b21b6;
            border: 2px solid #8b5cf6;
        }
        
        .condition-è…¦ä¸­é¢¨ {
            background: linear-gradient(135deg, #fecaca 0%, #f87171 100%);
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .condition-è¡°å¼±é«˜é½¡ {
            background: linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%);
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .badge.bg-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        /* çµæ¡ˆç‹€æ…‹æ¨£å¼ */
        .case-status {
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .case-status.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 2px solid #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .case-status.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .case-status.closed {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: 2px solid #6b7280;
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        .case-status.closed:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
        }
        
        /* å€‹ç®¡å¸«æ¨£å¼ */
        .case-manager {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
            border-radius: 8px;
            border: 2px solid #6366f1;
            color: #4f46e5;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .case-manager i {
            color: #818cf8;
        }
        
        .btn-secondary {
            border-radius: 10px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }
        
        /* Loading æ¨£å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #4b5563;
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text" id="loadingText">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <div class="container-fluid mt-4 px-4">
        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-heartbeat me-2"></i>AI å€‹æ¡ˆç®¡ç†ç³»çµ±</h1>
                <p class="mb-0 mt-2" style="opacity: 0.9; font-size: 1rem;"><i class="fas fa-users me-2"></i>ç”¨å¿ƒç…§è­·æ¯ä¸€ä½å€‹æ¡ˆ</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success btn-lg" onclick="showAddCaseModal()"><i class="fas fa-plus me-2"></i>æ–°å¢å€‹æ¡ˆ</button>
                <a href="index-gpt.html" class="btn btn-light btn-lg"><i class="fas fa-home me-2"></i>å›é¦–é </a>
            </div>
        </div>

        <div class="info-box d-flex align-items-center">
            <i class="fas fa-info-circle me-3 fs-4"></i>
            <div>
                <strong style="font-size: 1.05rem;">è©•ä¼°é€²åº¦èªªæ˜</strong>
                <p class="mb-0 mt-1"><i class="fas fa-check-circle text-success me-2"></i>ç¶ è‰²æŒ‰éˆ•ä»£è¡¨å·²å®Œæˆè©•ä¼°ï¼Œé»æ“ŠæŒ‰éˆ•å¯æŸ¥çœ‹æˆ–ç·¨è¼¯è©•ä¼°è³‡æ–™</p>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 120px;"><i class="fas fa-hashtag me-2"></i>å€‹æ¡ˆç·¨è™Ÿ</th>
                                <th scope="col" style="width: 120px;"><i class="fas fa-user me-2"></i>å§“å</th>
                                <th scope="col" style="width: 100px;"><i class="fas fa-tag me-2"></i>é¡å‹</th>
                                <th scope="col" style="width: 150px;"><i class="fas fa-notes-medical me-2"></i>ç‹€æ³</th>
                                <th scope="col" style="width: 140px;"><i class="fas fa-hotel me-2"></i>å…¥ä½æ™‚é–“</th>
                                <th scope="col" style="width: 140px;"><i class="fas fa-sync-alt me-2"></i>è¤‡è©•æ™‚é–“</th>
                                <th scope="col" style="width: 140px;"><i class="fas fa-clipboard-check me-2"></i>çµè©•æ™‚é–“</th>
                                <th scope="col" style="width: 140px;"><i class="fas fa-sign-out-alt me-2"></i>å‡ºé™¢æ™‚é–“</th>
                                <th scope="col"><i class="fas fa-tasks me-2"></i>è©•ä¼°é€²åº¦</th>
                                <th scope="col" style="width: 150px;"><i class="fas fa-cog me-2"></i>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="caseListBody">
                            <!-- Data will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯å€‹æ¡ˆ Modal -->
    <div class="modal fade" id="caseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="caseModalTitle"><i class="fas fa-user-plus me-2"></i>æ–°å¢å€‹æ¡ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="caseForm">
                        <input type="hidden" id="caseIndex" value="">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="caseId" class="form-label">å€‹æ¡ˆç·¨è™Ÿ *</label>
                                <input type="text" class="form-control" id="caseId" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="caseName" class="form-label">å§“å *</label>
                                <input type="text" class="form-control" id="caseName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="caseType" class="form-label">é¡å‹ *</label>
                                <select class="form-select" id="caseType" required>
                                    <option value="PAC">PAC</option>
                                    <option value="å±…å®¶">å±…å®¶</option>
                                    <option value="ç¤¾å€">ç¤¾å€</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="caseCondition" class="form-label">ç‹€æ³ *</label>
                                <select class="form-select" id="caseCondition" required>
                                    <option value="è…¦ä¸­é¢¨">è…¦ä¸­é¢¨</option>
                                    <option value="ç¥ç¶“æå‚·">ç¥ç¶“æå‚·</option>
                                    <option value="è„†éª¨">è„†éª¨</option>
                                    <option value="è¡°å¼±é«˜é½¡">è¡°å¼±é«˜é½¡</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="admissionDate" class="form-label">å…¥ä½æ™‚é–“</label>
                                <input type="datetime-local" class="form-control" id="admissionDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="reviewDate" class="form-label">è¤‡è©•æ™‚é–“</label>
                                <input type="datetime-local" class="form-control" id="reviewDate">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="finalReviewDate" class="form-label">çµè©•æ™‚é–“</label>
                                <input type="datetime-local" class="form-control" id="finalReviewDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dischargeDate" class="form-label">å‡ºé™¢æ™‚é–“</label>
                                <input type="datetime-local" class="form-control" id="dischargeDate">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è©•ä¼°é€²åº¦</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="status-åˆè©•" value="åˆè©•">
                                        <label class="form-check-label" for="status-åˆè©•">åˆè©•</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="status-22å¤©è¤‡è©•" value="22å¤©è¤‡è©•">
                                        <label class="form-check-label" for="status-22å¤©è¤‡è©•">22å¤©è¤‡è©•</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="status-42å¤©è¤‡è©•" value="42å¤©è¤‡è©•">
                                        <label class="form-check-label" for="status-42å¤©è¤‡è©•">42å¤©è¤‡è©•</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="status-64å¤©è¤‡è©•" value="64å¤©è¤‡è©•">
                                        <label class="form-check-label" for="status-64å¤©è¤‡è©•">64å¤©è¤‡è©•</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="status-82å¤©è¤‡è©•" value="82å¤©è¤‡è©•">
                                        <label class="form-check-label" for="status-82å¤©è¤‡è©•">82å¤©è¤‡è©•</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="status-çµè©•" value="çµè©•">
                                        <label class="form-check-label" for="status-çµè©•">çµè©•</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveCase()"><i class="fas fa-save me-2"></i>å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // è¨­ç½® API Tokenï¼ˆå¿…é ˆèˆ‡ Apps Script ä¸­çš„ç›¸åŒï¼‰
        const SECURITY_TOKEN = 'your-secure-token-here-change-this';
        
        // è¼¸å…¥é©—è­‰å‡½æ•¸
        function validateCaseData(caseData) {
            // é©—è­‰å€‹æ¡ˆç·¨è™Ÿæ ¼å¼
            if (!caseData.id || !/^C\d{3}$/.test(caseData.id)) {
                throw new Error('å€‹æ¡ˆç·¨è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚º C + 3 ä½æ•¸å­—');
            }
            
            // é©—è­‰å§“åï¼ˆä¸è¶…é 50 å­—å…ƒï¼‰
            if (!caseData.name || caseData.name.length > 50) {
                throw new Error('å§“åé•·åº¦ä¸æ­£ç¢º');
            }
            
            // é©—è­‰é¡å‹
            const validTypes = ['PAC', 'å±…å®¶', 'ç¤¾å€'];
            if (!validTypes.includes(caseData.type)) {
                throw new Error('é¡å‹ä¸æ­£ç¢º');
            }
            
            // é©—è­‰ç‹€æ³
            const validConditions = ['è„†éª¨', 'ç¥ç¶“æå‚·', 'è…¦ä¸­é¢¨', 'è¡°å¼±é«˜é½¡'];
            if (!validConditions.includes(caseData.condition)) {
                throw new Error('ç‹€æ³ä¸æ­£ç¢º');
            }
            
            return true;
        }

        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Google Sheets API è¨­å®šï¼ˆè®€å–ç”¨ï¼‰
        const API_KEY = 'AIzaSyA0JKp0Y8ZmGDHcPEmf4ncaWvnTMtoa8KM';
        const SHEET_ID = '1x32_JhOr0BTeoiS3gaw48Le8mJtiwd597DOjKyInoeU';
        const SHEET_NAME = 'å€‹æ¡ˆç®¡ç†';

        let cases = []; // å¾ Google Sheets è¼‰å…¥çš„è³‡æ–™
        const milestones = ['åˆè©•', '22å¤©è¤‡è©•', '42å¤©è¤‡è©•', '64å¤©è¤‡è©•', '82å¤©è¤‡è©•', 'çµè©•'];
        const conditions = ['è„†éª¨', 'ç¥ç¶“æå‚·', 'è…¦ä¸­é¢¨', 'è¡°å¼±é«˜é½¡'];

        // Loading é¡¯ç¤º/éš±è—å‡½æ•¸
        function showLoading(text = 'è¼‰å…¥ä¸­...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // å¾ Google Sheets è¼‰å…¥è³‡æ–™ï¼ˆé€é Apps Script APIï¼‰
        async function loadCasesFromGoogleSheets() {
            showLoading('æ­£åœ¨è¼‰å…¥å€‹æ¡ˆè³‡æ–™...');
            try {
                console.log('ğŸ” ä½¿ç”¨ Google Sheets API è¼‰å…¥è³‡æ–™...');
                
                // ä½¿ç”¨ Google Sheets API v4 ç›´æ¥è®€å–
                const range = encodeURIComponent(`${SHEET_NAME}!A2:I`);
                const timestamp = new Date().getTime();
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}&t=${timestamp}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤ ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                const rows = result.values || [];
                
                console.log(`âœ“ æˆåŠŸè®€å– ${rows.length} åˆ—è³‡æ–™`);
                
                // è§£æè³‡æ–™ (A=id, B=name, C=type, D=condition, E=admissionDate, F=reviewDate, G=finalReviewDate, H=dischargeDate, I=status)
                cases = rows.map((row, index) => {
                    try {
                        const id = row[0] || '';
                        if (!id) return null; // è·³éç©ºç™½åˆ—
                        
                        let status = {};
                        if (row[8]) {
                            try {
                                status = JSON.parse(row[8]);
                            } catch {
                                status = milestones.reduce((obj, m) => ({ ...obj, [m]: false }), {});
                            }
                        } else {
                            status = milestones.reduce((obj, m) => ({ ...obj, [m]: false }), {});
                        }
                        
                        return {
                            id: id,
                            name: row[1] || '',
                            type: row[2] || 'PAC',
                            condition: row[3] || '',
                            admissionDate: row[4] || '',
                            reviewDate: row[5] || '',
                            finalReviewDate: row[6] || '',
                            dischargeDate: row[7] || '',
                            status: status,
                            closed: false
                        };
                    } catch (e) {
                        console.error(`ç¬¬ ${index + 2} åˆ—è³‡æ–™è§£æéŒ¯èª¤:`, row, e);
                        return null;
                    }
                }).filter(c => c !== null);
                
                console.log(`âœ“ æˆåŠŸå¾ Google Sheets è¼‰å…¥ ${cases.length} ç­†å€‹æ¡ˆè³‡æ–™`);
                renderTable();
            } catch (error) {
                console.error('âŒ è¼‰å…¥ Google Sheets è³‡æ–™å¤±æ•—:', error);
                showErrorMessage(error.message);
            } finally {
                hideLoading();
            }
        }

        function showErrorMessage(message) {
            const infoBox = document.querySelector('.info-box');
            if (infoBox) {
                infoBox.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-3 fs-4 text-warning"></i>
                    <div>
                        <strong style="font-size: 1.05rem; color: #f57c00;">è³‡æ–™è¼‰å…¥æç¤º</strong>
                        <p class="mb-0 mt-1" style="color: #e65100;"><i class="fas fa-info-circle me-2"></i>${message}</p>
                        <p class="mb-0 mt-2 small"><strong>è§£æ±ºæ–¹å¼:</strong></p>
                        <ol class="small mb-0 mt-1">
                            <li>é–‹å•Ÿ <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}" target="_blank" class="text-primary">Google Sheets</a></li>
                            <li>é»æ“Šå³ä¸Šè§’ã€Œå…±ç”¨ã€â†’ è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººéƒ½å¯æŸ¥çœ‹ã€</li>
                            <li>ç¢ºèªå·¥ä½œè¡¨åç¨±ç‚ºã€Œ${SHEET_NAME}ã€</li>
                            <li>æŒ‰ F5 é‡æ–°æ•´ç†é é¢</li>
                        </ol>
                        <p class="mb-0 mt-2 small text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            è¨»:ç›®å‰åƒ…æ”¯æ´è®€å–åŠŸèƒ½,æ–°å¢/ç·¨è¼¯/åˆªé™¤è«‹ç›´æ¥åœ¨ Google Sheets ä¸­æ“ä½œã€‚
                        </p>
                    </div>
                `;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“é¡¯ç¤ºï¼ˆé¡¯ç¤ºåˆ°åˆ†é˜ï¼‰
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            try {
                const dt = new Date(dateTimeString);
                if (isNaN(dt.getTime())) return dateTimeString;
                
                const year = dt.getFullYear();
                const month = String(dt.getMonth() + 1).padStart(2, '0');
                const day = String(dt.getDate()).padStart(2, '0');
                const hours = String(dt.getHours()).padStart(2, '0');
                const minutes = String(dt.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (e) {
                return dateTimeString;
            }
        }

        // è½‰æ›ç‚º datetime-local è¼¸å…¥æ¬„ä½æ ¼å¼ï¼ˆYYYY-MM-DDTHH:MMï¼‰
        function toDateTimeLocalFormat(dateTimeString) {
            if (!dateTimeString) return '';
            try {
                const dt = new Date(dateTimeString);
                if (isNaN(dt.getTime())) return '';
                
                const year = dt.getFullYear();
                const month = String(dt.getMonth() + 1).padStart(2, '0');
                const day = String(dt.getDate()).padStart(2, '0');
                const hours = String(dt.getHours()).padStart(2, '0');
                const minutes = String(dt.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (e) {
                return '';
            }
        }

        // ç‹€æ³åœ–ç¤ºå°æ‡‰
        const conditionIcons = {
            'è„†éª¨': 'fa-bone',
            'ç¥ç¶“æå‚·': 'fa-project-diagram',
            'è…¦ä¸­é¢¨': 'fa-head-side-virus',
            'è¡°å¼±é«˜é½¡': 'fa-user-clock'
        };
        
        function renderTable() {
            const tbody = document.getElementById('caseListBody');
            tbody.innerHTML = '';

            cases.forEach(c => {
                const tr = document.createElement('tr');
                
                let buttonsHtml = '';
                milestones.forEach(m => {
                    const isCompleted = c.status[m];
                    const btnClass = isCompleted ? 'btn-outline-success completed' : 'btn-outline-primary';
                    // Pass case ID, name, milestone type, and condition to the next page
                    const url = `AIæ™ºæ…§å€‹ç®¡ç³»çµ±.html?id=${c.id}&name=${encodeURIComponent(c.name)}&stage=${encodeURIComponent(m)}&condition=${encodeURIComponent(c.condition)}`;
                    
                    buttonsHtml += `
                        <a href="${url}" class="btn ${btnClass} btn-sm status-btn">
                            ${m} <i class="fas fa-check"></i>
                        </a>
                    `;
                });
                
                // æ ¹æ“šç‹€æ³é¸æ“‡å°æ‡‰çš„åœ–ç¤ºå’Œæ¨£å¼
                const conditionIcon = conditionIcons[c.condition] || 'fa-notes-medical';
                const conditionClass = `condition-${c.condition}`;
                
                // çµæ¡ˆç‹€æ…‹é¡¯ç¤º
                const caseStatusHtml = c.closed 
                    ? `<span class="case-status closed"><i class="fas fa-check-circle"></i>å·²çµæ¡ˆ</span>`
                    : `<span class="case-status active"><i class="fas fa-heartbeat"></i>é€²è¡Œä¸­</span>`;

                tr.innerHTML = `
                    <td><strong>${escapeHtml(c.id)}</strong></td>
                    <td><i class="fas fa-user-circle text-primary me-2"></i>${escapeHtml(c.name)}</td>
                    <td><span class="badge bg-primary">${escapeHtml(c.type)}</span></td>
                    <td><span class="badge-condition ${conditionClass}"><i class="fas ${conditionIcon}"></i>${escapeHtml(c.condition)}</span></td>
                    <td>${formatDateTime(c.admissionDate)}</td>
                    <td>${formatDateTime(c.reviewDate)}</td>
                    <td>${formatDateTime(c.finalReviewDate)}</td>
                    <td>${formatDateTime(c.dischargeDate)}</td>
                    <td>${buttonsHtml}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editCase(${cases.indexOf(c)})" title="ç·¨è¼¯">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCase(${cases.indexOf(c)})" title="åˆªé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // é¡¯ç¤ºæ–°å¢å€‹æ¡ˆ Modal
        function showAddCaseModal() {
            document.getElementById('caseModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>æ–°å¢å€‹æ¡ˆ';
            document.getElementById('caseForm').reset();
            document.getElementById('caseIndex').value = '';
            const modal = new bootstrap.Modal(document.getElementById('caseModal'));
            modal.show();
        }

        // ç·¨è¼¯å€‹æ¡ˆ
        function editCase(index) {
            const c = cases[index];
            document.getElementById('caseModalTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>ç·¨è¼¯å€‹æ¡ˆ';
            document.getElementById('caseIndex').value = index;
            document.getElementById('caseId').value = c.id;
            document.getElementById('caseName').value = c.name;
            document.getElementById('caseType').value = c.type;
            document.getElementById('caseCondition').value = c.condition;
            
            // ä½¿ç”¨è½‰æ›å‡½æ•¸è¨­å®š datetime-local æ ¼å¼
            document.getElementById('admissionDate').value = toDateTimeLocalFormat(c.admissionDate);
            document.getElementById('reviewDate').value = toDateTimeLocalFormat(c.reviewDate);
            document.getElementById('finalReviewDate').value = toDateTimeLocalFormat(c.finalReviewDate);
            document.getElementById('dischargeDate').value = toDateTimeLocalFormat(c.dischargeDate);
            
            // è¨­å®šè©•ä¼°é€²åº¦ checkbox
            milestones.forEach(m => {
                const checkbox = document.getElementById(`status-${m}`);
                if (checkbox) {
                    checkbox.checked = c.status[m] || false;
                }
            });
            
            const modal = new bootstrap.Modal(document.getElementById('caseModal'));
            modal.show();
        }

        // å„²å­˜å€‹æ¡ˆ
        async function saveCase() {
            const form = document.getElementById('caseForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const status = {};
            milestones.forEach(m => {
                const checkbox = document.getElementById(`status-${m}`);
                status[m] = checkbox ? checkbox.checked : false;
            });

            const caseData = {
                id: document.getElementById('caseId').value,
                name: document.getElementById('caseName').value,
                type: document.getElementById('caseType').value,
                condition: document.getElementById('caseCondition').value,
                admissionDate: document.getElementById('admissionDate').value,
                reviewDate: document.getElementById('reviewDate').value,
                finalReviewDate: document.getElementById('finalReviewDate').value,
                dischargeDate: document.getElementById('dischargeDate').value,
                status: status,
                closed: false
            };

            const index = document.getElementById('caseIndex').value;
            if (index === '') {
                // æ–°å¢
                cases.push(caseData);
            } else {
                // ç·¨è¼¯
                cases[parseInt(index)] = caseData;
            }

            // åŒæ­¥åˆ° Google Sheets
            showLoading('æ­£åœ¨åŒæ­¥è³‡æ–™åˆ° Google Sheets...');
            try {
                await syncToGoogleSheets();
                renderTable();
                bootstrap.Modal.getInstance(document.getElementById('caseModal')).hide();
                hideLoading();
                alert('âœ“ å€‹æ¡ˆå·²æˆåŠŸå„²å­˜ä¸¦åŒæ­¥åˆ° Google Sheetsï¼');
            } catch (error) {
                console.error('åŒæ­¥å¤±æ•—:', error);
                renderTable();
                bootstrap.Modal.getInstance(document.getElementById('caseModal')).hide();
                hideLoading();
                alert(`âš ï¸ å€‹æ¡ˆå·²åœ¨æœ¬åœ°å„²å­˜ï¼Œä½†åŒæ­¥åˆ° Google Sheets å¤±æ•—ï¼š\n${error.message}\n\nè«‹æª¢æŸ¥ API æ¬Šé™è¨­å®šã€‚`);
            }
        }

        // åˆªé™¤å€‹æ¡ˆ
        async function deleteCase(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å€‹æ¡ˆå—ï¼Ÿ')) {
                cases.splice(index, 1);
                
                // åŒæ­¥åˆ° Google Sheets
                showLoading('æ­£åœ¨åŒæ­¥åˆªé™¤åˆ° Google Sheets...');
                try {
                    await syncToGoogleSheets();
                    renderTable();
                    hideLoading();
                    alert('âœ“ å€‹æ¡ˆå·²æˆåŠŸåˆªé™¤ä¸¦åŒæ­¥åˆ° Google Sheetsï¼');
                } catch (error) {
                    console.error('åŒæ­¥å¤±æ•—:', error);
                    renderTable();
                    hideLoading();
                    alert(`âš ï¸ å€‹æ¡ˆå·²åœ¨æœ¬åœ°åˆªé™¤ï¼Œä½†åŒæ­¥åˆ° Google Sheets å¤±æ•—ï¼š\n${error.message}\n\nè«‹æª¢æŸ¥ API æ¬Šé™è¨­å®šã€‚`);
                }
            }
        }

        // åŒæ­¥è³‡æ–™åˆ° Google Sheets
        async function syncToGoogleSheets() {
            // æº–å‚™è³‡æ–™ï¼šApps Script éœ€è¦å®Œæ•´ç‰©ä»¶
            if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE') {
                throw new Error('è«‹å…ˆè¨­å®š APPS_SCRIPT_URL');
            }

            const payload = {
                action: 'sync',
                token: SECURITY_TOKEN,  // æ–°å¢
                cases: cases.map(c => ({
                    id: c.id,
                    name: c.name,
                    type: c.type,
                    condition: c.condition,
                    admissionDate: c.admissionDate,
                    reviewDate: c.reviewDate,
                    finalReviewDate: c.finalReviewDate,
                    dischargeDate: c.dischargeDate,
                    status: c.status
                }))
            };

            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP éŒ¯èª¤ ${response.status}`);
            }

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'åŒæ­¥å¤±æ•—');
            }

            console.log('âœ“ è³‡æ–™å·²æˆåŠŸåŒæ­¥åˆ° Google Sheets:', result.message);
            return result;
        }

        document.addEventListener('DOMContentLoaded', loadCasesFromGoogleSheets);
    </script>
</body>
</html>
