# 深耕計劃經費追蹤表 - 部署與使用指南

## 目錄
1. [功能概述](#功能概述)
2. [後端部署（Apps Script）](#後端部署apps-script)
3. [前端設定](#前端設定)
4. [使用說明](#使用說明)
5. [常見問題](#常見問題)
6. [故障排除](#故障排除)

---

## 功能概述

### 新增功能
- **即時編輯**：直接在表格中點擊數字進行修改
- **本地保存**：編輯結果自動儲存到瀏覽器（localStorage）
- **同步到 Google Sheets**：修改內容可寫回原始試算表
- **欄位保護**：衍生公式欄位（小計、總計等）禁止直接編輯
- **白名單驗證**：僅允許指定使用者寫入資料

### 支援編輯的欄位
✅ 人事費、業務費、資本門（申請數與執行數）
✅ 各項配合款金額
✅ 範疇一～四的補助款與配合款

### 禁止編輯的欄位
❌ 總補助款、總配合款、總經費（衍生公式）
❌ 資本門比例、執行率（百分比）

---

## 後端部署（Apps Script）

### 步驟 1：開啟 Apps Script 編輯器

1. 在瀏覽器開啟目標試算表
   - 連結：https://docs.google.com/spreadsheets/d/1x32_JhOr0BTeoiS3gaw48Le8mJtiwd597DOjKyInoeU/

2. 點選「擴充功能」→ 「Apps Script」
   - 首次使用會跳到新視窗，直接進入編輯器

### 步驟 2：建立新檔案

1. 在左側「檔案」區域點「➕」新增檔案
2. 選擇「指令碼」
3. 將檔案名稱改為 `Code`（預設為 `untitled`）

### 步驟 3：貼上後端程式碼

複製以下完整程式碼並貼入編輯器：

```javascript
/**
 * 深耕計劃經費追蹤表 - 寫入後端
 * - 接收前端 POST 的變更清單，批次寫入 Google 試算表
 * - 白名單驗證：僅允許指定 Email
 * - 完整錯誤回傳、輸入校驗與日誌
 */

const CONFIG = {
  sheetNameDefault: '深耕計劃經費追蹤表',
  allowedEmails: [
    // TODO: 修改為你的 Google 帳號（支援多個）
    'you@example.com',
  ],
  // 可選：簡易 Token 認證（若瀏覽器無法取得使用者 Email 時可改用 Token）
  // 請設定為隨機字串並妥善保管，例如 'HTSprout-2025-Secret-XYZ'
  tokenSecret: 'CHANGE_ME_TOKEN',
  // 啟用詳細日誌（部署正式環境可改為 false）
  verboseLog: true,
};

/**
 * Web App 入口：接收前端 JSON POST
 * 期待 payload 格式：
 * {
 *   sheetName: '深耕計劃經費追蹤表',
 *   changes: [{ row: 15, col: 12, value: 666666 }, ...] // 零基 index
 * }
 */
function doPost(e) {
  const started = new Date();
  try {
    // 1) 基本檢查
    if (!e || !e.postData || !e.postData.contents) {
      return jsonResponse({ ok: false, error: 'missing post data' }, 400);
    }

    // 3) 解析 payload
    let data;
    try {
      data = JSON.parse(e.postData.contents);
    } catch (parseErr) {
      return jsonResponse({ ok: false, error: 'invalid json payload' }, 400);
    }

    // 2) 身分驗證（Token 或白名單 Email 任一通過即可）
    const token = (data && data.token) || '';
    const tokenOk = tokenMatches(token);
    let userEmail = '';
    let emailOk = false;
    if (!tokenOk) {
      userEmail = getActiveUserEmailSafe();
      if (!userEmail) {
        return jsonResponse({ ok: false, error: 'unauthenticated: no active user' }, 401);
      }
      emailOk = CONFIG.allowedEmails.includes(userEmail);
      if (!emailOk) {
        return jsonResponse({ ok: false, error: `unauthorized: ${userEmail}` }, 403);
      }
    }

    const sheetName = (data && data.sheetName) || CONFIG.sheetNameDefault;
    const changes = (data && data.changes) || [];

    // 4) 輸入校驗
    const validateResult = validateChanges(changes);
    if (!validateResult.ok) {
      return jsonResponse({ ok: false, error: validateResult.error, details: validateResult.details }, 400);
    }

    // 5) 取得工作表
    const ss = SpreadsheetApp.getActive();
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      return jsonResponse({ ok: false, error: `sheet not found: ${sheetName}` }, 404);
    }

    // 6) 批次寫入
    const writeSummary = writeChanges(sheet, changes);

    // 7) 成功回傳
    const finished = new Date();
    const ms = finished.getTime() - started.getTime();
    return jsonResponse({
      ok: true,
      user: userEmail || 'by-token',
      sheet: sheetName,
      summary: writeSummary,
      elapsedMs: ms,
    }, 200);
  } catch (err) {
    // 8) 例外攔截
    return jsonResponse({ ok: false, error: String(err) }, 500);
  }
}

/**
 * 取得目前執行者 Email（可能會是空字串）
 */
function getActiveUserEmailSafe() {
  try {
    const email = Session.getActiveUser().getEmail();
    if (CONFIG.verboseLog) Logger.log('ActiveUser: ' + email);
    return email || '';
  } catch (e) {
    return '';
  }
}

/**
 * 檢查 changes 資料格式與範圍
 */
function validateChanges(changes) {
  const details = [];
  if (!Array.isArray(changes) || changes.length === 0) {
    return { ok: false, error: 'no changes provided', details };
  }
  for (let i = 0; i < changes.length; i++) {
    const c = changes[i];
    if (typeof c.row !== 'number' || typeof c.col !== 'number') {
      details.push(`index ${i}: row/col must be numbers`);
      continue;
    }
    if (!Number.isInteger(c.row) || !Number.isInteger(c.col) || c.row < 0 || c.col < 0) {
      details.push(`index ${i}: row/col invalid (non-integer or negative)`);
      continue;
    }
    if (c.value === undefined || c.value === null || c.value === '') {
      details.push(`index ${i}: value is empty`);
      continue;
    }
    const num = Number(c.value);
    if (Number.isNaN(num)) {
      details.push(`index ${i}: value not a number (${c.value})`);
      continue;
    }
  }
  if (details.length > 0) {
    return { ok: false, error: 'validation failed', details };
  }
  return { ok: true };
}

/**
 * 批次寫入（逐筆 setValue）
 */
function writeChanges(sheet, changes) {
  const summary = {
    total: changes.length,
    success: 0,
    failed: 0,
    errors: [],
  };

  for (let i = 0; i < changes.length; i++) {
    const c = changes[i];
    // Apps Script 是一基座標，前端傳來零基需 +1
    const r = c.row + 1;
    const col = c.col + 1;
    try {
      sheet.getRange(r, col).setValue(c.value);
      summary.success++;
      if (CONFIG.verboseLog) Logger.log(`Wrote r${r} c${col} = ${c.value}`);
    } catch (err) {
      summary.failed++;
      summary.errors.push({ index: i, row: c.row, col: c.col, error: String(err) });
    }
  }
  return summary;
}

/**
 * 套件化 JSON 回應
 * Note: Apps Script ContentService 的 TextOutput 不支援 setHeader，
 * 但 Google 會自動允許 Web App 呼叫。若需明確控制，
 * 則應使用 Apps Script 提供的標準 Web App 回應。
 */
function jsonResponse(obj, status) {
  obj.status = status;
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * 檢查前端提供的 Token 是否有效
 */
function tokenMatches(token) {
  const expected = (CONFIG && CONFIG.tokenSecret) || '';
  if (!expected) return false;
  return token && token === expected;
}

/**
 * 提示：避免觸發 CORS 預檢
 * - 前端請不要手動設定 Content-Type 標頭（瀏覽器會自動處理）
 * - 請用本地伺服器開啟頁面（http://localhost:8000），不要用 file://（origin 會是 null）
 * - Apps Script Web App 會允許跨來源回應，不需手動設置回應標頭
 */
```

### 步驟 4：設定白名單

1. 在程式碼第 10 行找到 `allowedEmails` 陣列
2. 修改為你的 Gmail 帳號（可多個）：
   ```javascript
   allowedEmails: [
     'your.email@gmail.com',
     'colleague@gmail.com',  // 可添加多人
   ],
   ```

### 步驟 5：部署為網路應用程式

1. 點選「部署」→ 「部署為新版本」
2. 選擇版本類型：「新版本」
3. 點「建立新的部署」
4. 部署類型：選擇「網路應用程式」

| 欄位 | 設定值 |
|------|-------|
| 執行身份 | 本人 |
| 存取權限 | 任何有連結但需登入的使用者 |

5. 點「部署」

### 步驟 6：取得部署 URL

1. 部署完成後會顯示「網路應用程式 URL」
2. 複製此 URL（格式類似：`https://script.google.com/macros/s/AKfy...../exec`）
3. 妥善保管（後面會用到）

---

## 前端設定

### 步驟 1：設定同步目的地

1. 在瀏覽器中開啟深耕計劃經費追蹤表
  - 建議使用本地伺服器（避免 `origin null` CORS）：
    ```bash
    cd /Users/yangjames/Desktop/台灣健康辦公室/0.深耕計劃入口網/gpt
    python -m http.server 8000
    ```
    然後以 `http://localhost:8000/深耕計劃經費追蹤表.html` 開啟。
  - 若直接用檔案路徑 (`file://`) 開啟，請確保後端已回應 `Access-Control-Allow-Origin: *`。

2. 打開開發者工具
   - 按 `F12` 或 `Cmd+Option+I`（Mac）

3. 進入 Console 分頁

4. 貼入以下命令（將 URL 替換為前面複製的 Web App URL）：
   ```javascript
  // 為避免 CORS 預檢（OPTIONS），請保持前端 fetch 無自訂 Content-Type 標頭
  // 僅需設定同步 URL
  localStorage.setItem('budgetSyncUrl', 'https://script.google.com/macros/s/AKfycbyK5ESIA8NCt6RBVmiMPYAO8EHli1W_Mampa6iNYXp70EJlLp-Xfm_gHGvlsQjCknpI/exec');
  // 可選：設定同步 Token（需與 Apps Script CONFIG.tokenSecret 一致）
  localStorage.setItem('budgetSyncToken', 'CHANGE_ME_TOKEN');
   ```

5. 按 Enter 執行

6. 驗證設定成功：
   ```javascript
   localStorage.getItem('budgetSyncUrl');
   ```
   應回傳你剛設定的 URL

---

## 使用說明

### 編輯表格

1. **啟用編輯模式**
   - 點擊頁面中的「啟用編輯模式」按鈕（黃色）
   - 頁面頂部會顯示紅色提示：「編輯模式已啟用」

2. **修改數字**
   - 點擊任何數字儲存格（會看到 ✏️ 標記）
   - 輸入新數值
   - 按 Enter 或點擊其他地方完成編輯
   - 新數值會自動格式化（加入千分位）

3. **保存變更**
   - 修改後右下角會出現「保存變更」按鈕（綠色）
   - 點擊按鈕
   - 會看到修改清單確認對話框
   - 確認後：
     - ✅ 本地保存到瀏覽器
     - ✅ 嘗試同步到 Google Sheets
     - 同步中會顯示「同步中…」的旋轉圖示

### 保護的欄位

以下欄位**禁止直接編輯**（會跳出警告提示）：
- 總補助款
- 總配合款
- 總經費
- 資本門比例
- 執行進度小計/總計

**原因**：這些欄位由試算表公式自動計算。若要改變結果，請修改來源數值（人事費、業務費等）。

---

## 常見問題

### Q1：同步失敗，顯示「unauthorized」

**A**：你的 Google 帳號未加入白名單。

**解決方案**：
1. 打開 Apps Script 編輯器
2. 修改 `CONFIG.allowedEmails` 陣列，加入你的 Gmail
3. 重新部署（部署 → 部署為新版本 → 建立新的部署）
4. 重新整理頁面後重試

### Q2：同步失敗，顯示「unauthenticated」

**A**：Apps Script 無法取得你的 Google 帳號資訊。

**解決方案**：
1. 登出 Google，再重新登入
2. 重新整理頁面
3. 重試同步

### Q3：我修改了受保護的欄位（如總補助款），為什麼沒有同步？

**A**：這是正常的。衍生公式欄位會被系統自動過濾掉，不會送到 Google Sheets。

**正確做法**：
- 改為修改「來源欄位」（如人事費、業務費）
- 試算表會自動重新計算總補助款

### Q4：如何修改同步 URL？

**A**：在開發者工具 Console 重新執行：
```javascript
localStorage.setItem('budgetSyncUrl', '新的URL');
```

### Q5：本地保存的資料會過期嗎？

**A**：不會。localStorage 會一直保存，直到你清除瀏覽器快取。

**查看本地保存的資料**：
```javascript
JSON.parse(localStorage.getItem('budgetData'));
```

**清除本地保存**（慎用）：
```javascript
localStorage.removeItem('budgetData');
localStorage.removeItem('budgetSyncUrl');
```

### Q6：可以在多台電腦上使用嗎？

**A**：可以。每台電腦的 localStorage 獨立。

**建議**：
- 在每台電腦上各執行一次 `localStorage.setItem('budgetSyncUrl', ...)` 設定同步 URL
- 或使用 Cloud Storage 同步設定（需額外開發）

### Q7：編輯後發現輸入錯誤，怎麼回復？

**A**：
1. **未保存前**：關閉編輯模式（按「關閉編輯模式」）
   - 或重新整理頁面（未保存的修改會遺失）

2. **已保存到本地**：下次開啟頁面會詢問是否載入本地保存
   - 選「取消」可忽略本地版本，使用 Google Sheets 最新資料

3. **已同步到 Google Sheets**：
   - 在 Google Sheets 中手動修正
   - 重新整理頁面以讀取最新資料

### Q8：如何禁止某些使用者修改？

**A**：在 Apps Script 白名單中移除該使用者。

**後續該使用者若嘗試同步**：
- 會收到「unauthorized」錯誤提示
- 本地修改會被保留，但不會寫入 Google Sheets

### Q9：可以批次匯入資料嗎？

**A**：目前不支援。只能逐筆修改。

**未來可加的功能**：
- CSV 匯入
- 批次上傳 JSON 檔案

---

## 故障排除

### 頁面載入失敗

**症狀**：頁面完全空白或顯示 JavaScript 錯誤

**排除步驟**：
1. 重新整理頁面（Cmd+R）
2. 清除快取（Cmd+Shift+Delete）
3. 在隱身模式開啟頁面
4. 檢查瀏覽器主控台是否有錯誤（F12 → Console）

### 無法進入編輯模式

**症狀**：點「啟用編輯模式」沒反應

**排除步驟**：
1. 檢查瀏覽器主控台（F12 → Console）是否有紅色錯誤
2. 重新整理頁面
3. 嘗試另一個瀏覽器

### 同步一直顯示「同步中…」

**症狀**：按鈕卡在旋轉狀態，無法完成

**排除步驟**：
1. 等待 30 秒（可能網路慢）
2. 重新整理頁面
3. 檢查網路連線
4. 查看 Apps Script 執行日誌是否有錯誤：
   - 開啟 Apps Script → 執行日誌
   - 查找最近的執行記錄
5. 確認前端 fetch 沒有手動加入 `Content-Type` 標頭（避免 CORS 預檢）

### Google Sheets 資料未更新

**症狀**：同步顯示成功，但 Google Sheets 中沒看到新資料

**排除步驟**：
1. 重新整理 Google Sheets 頁面
2. 檢查是否編輯的是正確的工作表名稱（應為「深耕計劃經費追蹤表」）
3. 檢查修改的儲存格座標是否正確（可在 Apps Script 執行日誌查看）
4. 確認試算表未被保護（試算表 → 保護工作表）

### 收到白名單拒絕但我已加入

**症狀**：同步失敗，顯示「unauthorized: xxx@gmail.com」

**排除步驟**：
1. 確認白名單中的 Email 與登入的 Email 完全相同（包括大小寫）
2. 登出 Google，重新登入
3. 重新部署 Apps Script（部署 → 部署為新版本）
4. 清除瀏覽器快取後重試

---

## 進階設定

### 啟用更詳細的日誌

在 Apps Script Code.gs 中：
```javascript
const CONFIG = {
  verboseLog: true,  // 改為 true
};
```

然後在 Apps Script 主頁按「執行日誌」查看詳細訊息。

### 限制可寫入的工作表

編輯 `CONFIG.sheetNameDefault` 或在 payload 中強制指定工作表名稱。

### 限制可修改的欄位

在前端 `coordMap` 中添加更多 `writable: false` 標記。

---

## 支援與回報

如發現問題或需要功能增強，請：

1. 查看本文檔的「故障排除」章節
2. 檢查 GitHub Issues：https://github.com/zardabab/htsproutHealthylicon
3. 直接聯絡開發人員

---

## 更新記錄

| 版本 | 日期 | 變更內容 |
|------|------|--------|
| v1.0 | 2025-12-17 | 初版：編輯功能、本地保存、Apps Script 同步、欄位保護 |

---

**最後更新**：2025 年 12 月 17 日
