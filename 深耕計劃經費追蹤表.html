<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深耕計劃經費追蹤表</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 0 auto;
            max-width: 1400px;
        }

        .header-section {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .content-section {
            padding: 30px;
        }

        .return-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .summary-card h5 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card .percentage {
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .table-title {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
        }

        .budget-table {
            width: 100%;
            font-size: 0.85rem;
        }

        .budget-table th {
            background: #e9ecef;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
            border: 2px solid #dee2e6;
            padding: 8px;
            white-space: nowrap;
        }

        .budget-table td {
            text-align: right;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            white-space: nowrap;
        }

        .category-header {
            background: #6c757d !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
        }

        .subcategory-header {
            background: #adb5bd !important;
            font-weight: bold;
            text-align: left;
        }

        .amount-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .total-row {
            background: #fff3cd !important;
            font-weight: bold;
        }

        .progress-row {
            background: #d1ecf1 !important;
            font-weight: bold;
            color: #0c5460;
        }

        .percentage-cell {
            color: #28a745;
            font-weight: bold;
        }

        .editable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .editable-cell:hover {
            background-color: #fff3cd !important;
        }

        .editable-cell:hover::after {
            content: '✏️';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .cell-input {
            width: 100%;
            border: 2px solid #007bff;
            padding: 4px;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: #fff;
        }

        .edit-mode-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: bold;
            display: none;
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .save-changes-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .section-divider {
            height: 3px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            margin: 30px 0;
            border-radius: 2px;
        }

        .progress-summary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-summary h4 {
            color: #8b4513;
            margin-bottom: 15px;
        }

        .progress-bars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .progress-item {
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 8px;
        }

        .progress-item h6 {
            margin-bottom: 8px;
            color: #5a3818;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-bar-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .budget-table {
                font-size: 0.7rem;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 4px;
            }
            
            .header-section h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- 返回按鈕 -->
    <button class="btn btn-primary return-button" onclick="window.close()">
        <i class="fas fa-arrow-left me-1"></i>返回
    </button>

    <!-- 編輯模式提示 -->
    <div class="edit-mode-banner" id="editModeBanner">
        <i class="fas fa-edit me-2"></i>編輯模式已啟用 - 點擊數字進行修改
    </div>

    <!-- 保存變更按鈕 -->
    <button class="btn btn-success btn-lg save-changes-btn" id="saveChangesBtn" onclick="saveChanges()">
        <i class="fas fa-save me-2"></i>保存變更
    </button>

    <div class="container-fluid">
        <div class="main-container">
            <!-- 標題區 -->
            <div class="header-section">
                <h1><i class="fas fa-chart-line me-3"></i>深耕計劃經費追蹤表</h1>
                <p class="mb-0 fs-5">Deep Roots Program Budget Tracking</p>
            </div>

            <div class="content-section">
                <!-- 總覽卡片 -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <h5>總補助款 (A)</h5>
                        <div class="amount" id="cardTotalSubsidy">-</div>
                        <div class="percentage">申請金額</div>
                    </div>
                    <div class="summary-card">
                        <h5>總配合款 (F)</h5>
                        <div class="amount" id="cardTotalMatching">-</div>
                        <div class="percentage">配合款</div>
                    </div>
                    <div class="summary-card">
                        <h5>總經費 (G)</h5>
                        <div class="amount" id="cardTotal">-</div>
                        <div class="percentage">A + F</div>
                    </div>
                    <div class="summary-card">
                        <h5>資本門比例</h5>
                        <div class="amount" id="cardCapitalRatio">-</div>
                        <div class="percentage">占補助款</div>
                    </div>
                </div>

                <!-- 申請數據表 -->
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-file-invoice-dollar me-2"></i>申請數 - 第一階段
                    </div>
                    <div class="table-responsive">
                        <table class="table budget-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">範疇</th>
                                    <th colspan="2">範疇一</th>
                                    <th colspan="2">範疇二</th>
                                    <th colspan="2">範疇三</th>
                                    <th colspan="2">範疇四</th>
                                    <th colspan="3">總計(G)</th>
                                    <th colspan="2">配合款(F)</th>
                                </tr>
                                <tr>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款(A)</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td rowspan="4" class="subcategory-header">申請數<br>第一階段</td>
                                    <td class="amount-cell scope1-subsidy">-</td>
                                    <td class="amount-cell scope1-matching">-</td>
                                    <td class="amount-cell scope2-subsidy">-</td>
                                    <td class="amount-cell scope2-matching">-</td>
                                    <td class="amount-cell scope3-subsidy">-</td>
                                    <td class="amount-cell scope3-matching">-</td>
                                    <td class="amount-cell scope4-subsidy">-</td>
                                    <td class="amount-cell scope4-matching">-</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="subcategory-header">人事費</td>
                                    <td class="amount-cell" id="requestPersonnelCell">-</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="amount-cell" id="matchPersonnelCell">-</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td></td>
                                    <td class="subcategory-header">業務費</td>
                                    <td class="amount-cell" id="requestAffairsCell">-</td>
                                    <td></td>
                                    <td class="amount-cell" id="matchAffairsCell">-</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td></td>
                                    <td class="amount-cell" id="requestCapitalCell">-</td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="amount-cell" id="matchCapitalCell">-</td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="8"></td>
                                    <td class="amount-cell" id="totalSubsidyCell">-</td>
                                    <td></td>
                                    <td class="amount-cell" id="totalMatchingCell">-</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="9"></td>
                                    <td class="amount-cell" id="totalCell">-</td>
                                    <td colspan="4"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- 執行進度表 -->
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-chart-bar me-2"></i>執行進度 - 目前狀況
                    </div>
                    <div class="table-responsive">
                        <table class="table budget-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">範疇</th>
                                    <th colspan="2">範疇一</th>
                                    <th colspan="2">範疇二</th>
                                    <th colspan="2">範疇三</th>
                                    <th colspan="2">範疇四</th>
                                    <th colspan="3">總計(G)</th>
                                    <th colspan="2">配合款(F)</th>
                                </tr>
                                <tr>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款(A)</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td rowspan="4" class="subcategory-header">執行數<br>第一階段</td>
                                    <td class="amount-cell exec-scope1-subsidy">-</td>
                                    <td class="amount-cell exec-scope1-matching">-</td>
                                    <td class="amount-cell exec-scope2-subsidy">-</td>
                                    <td class="amount-cell exec-scope2-matching">-</td>
                                    <td class="amount-cell exec-scope3-subsidy">-</td>
                                    <td class="amount-cell exec-scope3-matching">-</td>
                                    <td class="amount-cell exec-scope4-subsidy">-</td>
                                    <td class="amount-cell exec-scope4-matching">-</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="subcategory-header">人事費</td>
                                    <td class="amount-cell" id="execPersonnelCell">-</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="amount-cell" id="execMatchPersonnelCell">-</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td></td>
                                    <td class="subcategory-header">業務費</td>
                                    <td class="amount-cell" id="execAffairsCell">-</td>
                                    <td></td>
                                    <td class="amount-cell" id="execMatchAffairsCell">-</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td></td>
                                    <td class="amount-cell" id="execCapitalCell">-</td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="amount-cell" id="execMatchCapitalCell">-</td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="8"></td>
                                    <td class="amount-cell" id="execTotalSubsidyCell">-</td>
                                    <td></td>
                                    <td class="amount-cell" id="execTotalMatchingCell">-</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="9"></td>
                                    <td class="amount-cell" id="execTotalCell">-</td>
                                    <td colspan="4"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 進度百分比表 -->
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-percentage me-2"></i>執行進度百分比
                    </div>
                    <div class="table-responsive">
                        <table class="table budget-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">項目</th>
                                    <th colspan="2">範疇一</th>
                                    <th colspan="2">範疇二</th>
                                    <th colspan="2">範疇三</th>
                                    <th colspan="2">範疇四</th>
                                    <th colspan="3">總計執行率</th>
                                    <th colspan="2">配合款執行率</th>
                                </tr>
                                <tr>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>項目</th>
                                    <th>執行率</th>
                                    <th>整體</th>
                                    <th>項目</th>
                                    <th>執行率</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="progress-row">
                                    <td class="subcategory-header">進度</td>
                                    <td class="percentage-cell">8.60%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">0.26%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">19.44%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="subcategory-header">經常門人事費</td>
                                    <td class="percentage-cell">1.86%</td>
                                    <td class="percentage-cell">1.71%</td>
                                    <td class="subcategory-header">經常門人事費</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                                <tr class="progress-row">
                                    <td colspan="9"></td>
                                    <td class="subcategory-header">經常門業務費</td>
                                    <td class="percentage-cell">5.29%</td>
                                    <td></td>
                                    <td class="subcategory-header">經常門業務費</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                                <tr class="progress-row">
                                    <td colspan="9"></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="percentage-cell">0.03%</td>
                                    <td></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                                <tr class="progress-row">
                                    <td colspan="9"></td>
                                    <td class="subcategory-header">整體進度</td>
                                    <td class="percentage-cell">1.89%</td>
                                    <td></td>
                                    <td class="subcategory-header">整體進度</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 視覺化進度摘要 -->
                <div class="progress-summary">
                    <h4><i class="fas fa-chart-pie me-2"></i>執行進度視覺化</h4>
                    <div class="progress-bars">
                        <div class="progress-item">
                            <h6>範疇一執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 8.6%"></div>
                            </div>
                            <small>8.60% (1,290,012 / 15,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>範疇二執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 0.26%"></div>
                            </div>
                            <small>0.26% (26,400 / 10,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>範疇三執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                            <small>0% (0 / 20,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>範疇四執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 19.44%"></div>
                            </div>
                            <small>19.44% (1,943,520 / 10,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>整體執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 1.89%"></div>
                            </div>
                            <small>1.89% (1,041,063 / 55,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>配合款執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                            <small>0% (0 / 5,825,000)</small>
                        </div>
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="text-center mt-4">
                    <button class="btn btn-warning btn-lg me-3" onclick="window.open('https://docs.google.com/spreadsheets/d/1x32_JhOr0BTeoiS3gaw48Le8mJtiwd597DOjKyInoeU/edit?gid=687531515#gid=687531515', '_blank')">
                        <i class="fas fa-edit me-2"></i>開啟 Google 試算表編輯
                    </button>
                    <button class="btn btn-info btn-lg me-3" onclick="printReport()">
                        <i class="fas fa-print me-2"></i>列印報表
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" onclick="window.open('指標.html', '_blank')">
                        <i class="fas fa-chart-bar me-2"></i>返回指標頁面
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * 深耕計劃經費追蹤表 - 寫入後端
         * - 接收前端 POST 的變更清單，批次寫入 Google 試算表
         * - 白名單驗證：僅允許指定 Email
         * - 完整錯誤回傳、輸入校驗與日誌
         */

        const CONFIG = {
        sheetNameDefault: '深耕計劃經費追蹤表',
        allowedEmails: [
            // TODO: 修改為你的 Google 帳號（支援多個）
            'ks.healthy77@gmail.com',
        ],
        // 啟用詳細日誌（部署正式環境可改為 false）
        verboseLog: true,
        };

        /**
         * Web App 入口：接收前端 JSON POST
         * 期待 payload 格式：
         * {
         *   sheetName: '深耕計劃經費追蹤表',
         *   changes: [{ row: 15, col: 12, value: 666666 }, ...] // 零基 index
         * }
         */
        function doPost(e) {
        const started = new Date();
        try {
            // 1) 基本檢查
            if (!e || !e.postData || !e.postData.contents) {
            return jsonResponse({ ok: false, error: 'missing post data' }, 400);
            }

            // 2) 身分驗證（白名單）
            const userEmail = getActiveUserEmailSafe();
            if (!userEmail) {
            return jsonResponse({ ok: false, error: 'unauthenticated: no active user' }, 401);
            }
            if (!CONFIG.allowedEmails.includes(userEmail)) {
            return jsonResponse({ ok: false, error: `unauthorized: ${userEmail}` }, 403);
            }

            // 3) 解析 payload
            let data;
            try {
            data = JSON.parse(e.postData.contents);
            } catch (parseErr) {
            return jsonResponse({ ok: false, error: 'invalid json payload' }, 400);
            }

            const sheetName = (data && data.sheetName) || CONFIG.sheetNameDefault;
            const changes = (data && data.changes) || [];

            // 4) 輸入校驗
            const validateResult = validateChanges(changes);
            if (!validateResult.ok) {
            return jsonResponse({ ok: false, error: validateResult.error, details: validateResult.details }, 400);
            }

            // 5) 取得工作表
            const ss = SpreadsheetApp.getActive();
            const sheet = ss.getSheetByName(sheetName);
            if (!sheet) {
            return jsonResponse({ ok: false, error: `sheet not found: ${sheetName}` }, 404);
            }

            // 6) 批次寫入
            const writeSummary = writeChanges(sheet, changes);

            // 7) 成功回傳
            const finished = new Date();
            const ms = finished.getTime() - started.getTime();
            return jsonResponse({
            ok: true,
            user: userEmail,
            sheet: sheetName,
            summary: writeSummary,
            elapsedMs: ms,
            }, 200);
        } catch (err) {
            // 8) 例外攔截
            return jsonResponse({ ok: false, error: String(err) }, 500);
        }
        }

        /**
         * 取得目前執行者 Email（可能會是空字串）
         */
        function getActiveUserEmailSafe() {
        try {
            const email = Session.getActiveUser().getEmail();
            if (CONFIG.verboseLog) Logger.log('ActiveUser: ' + email);
            return email || '';
        } catch (e) {
            return '';
        }
        }

        /**
         * 檢查 changes 資料格式與範圍
         */
        function validateChanges(changes) {
        const details = [];
        if (!Array.isArray(changes) || changes.length === 0) {
            return { ok: false, error: 'no changes provided', details };
        }
        for (let i = 0; i < changes.length; i++) {
            const c = changes[i];
            if (typeof c.row !== 'number' || typeof c.col !== 'number') {
            details.push(`index ${i}: row/col must be numbers`);
            continue;
            }
            if (!Number.isInteger(c.row) || !Number.isInteger(c.col) || c.row < 0 || c.col < 0) {
            details.push(`index ${i}: row/col invalid (non-integer or negative)`);
            continue;
            }
            if (c.value === undefined || c.value === null || c.value === '') {
            details.push(`index ${i}: value is empty`);
            continue;
            }
            const num = Number(c.value);
            if (Number.isNaN(num)) {
            details.push(`index ${i}: value not a number (${c.value})`);
            continue;
            }
        }
        if (details.length > 0) {
            return { ok: false, error: 'validation failed', details };
        }
        return { ok: true };
        }

        /**
         * 批次寫入（逐筆 setValue）
         */
        function writeChanges(sheet, changes) {
        const summary = {
            total: changes.length,
            success: 0,
            failed: 0,
            errors: [],
        };

        for (let i = 0; i < changes.length; i++) {
            const c = changes[i];
            // Apps Script 是一基座標，前端傳來零基需 +1
            const r = c.row + 1;
            const col = c.col + 1;
            try {
            sheet.getRange(r, col).setValue(c.value);
            summary.success++;
            if (CONFIG.verboseLog) Logger.log(`Wrote r${r} c${col} = ${c.value}`);
            } catch (err) {
            summary.failed++;
            summary.errors.push({ index: i, row: c.row, col: c.col, error: String(err) });
            }
        }
        return summary;
        }

        /**
         * 套件化 JSON 回應
         */
        function jsonResponse(obj, status) {
        const output = ContentService.createTextOutput(JSON.stringify(obj))
            .setMimeType(ContentService.MimeType.JSON);
        // CORS：允許跨網域（包含 file:// 與 localhost）
        output.setHeader('Access-Control-Allow-Origin', '*');
        output.setHeader('Access-Control-Allow-Methods', 'POST');
        output.setHeader('Access-Control-Allow-Headers', 'Content-Type');
        obj.status = status;
        return output;
        }
        
        // Google Sheets API 設定
        const SHEET_ID = '1x32_JhOr0BTeoiS3gaw48Le8mJtiwd597DOjKyInoeU';
        const SHEET_GID = '687531515'; // 深耕計劃經費追蹤表
        const WEB_APP_URL = localStorage.getItem('budgetSyncUrl') || ''; // Apps Script Web App URL（部署後貼上）
        
        // 編輯模式狀態
        let isEditMode = false;
        let originalData = null;
        let modifiedCells = new Map(); // 儲存被修改的儲存格 {cellId: {oldValue, newValue, row, col}}
        
        // 將語義欄位對應到試算表座標（零基 index）
        const coordMap = {
            // 申請數明細 R2-R4
            'request.personnelAmount': { row: 2, col: 12 },
            'request.matchPersonnelAmount': { row: 2, col: 15 },
            'request.affairsAmount': { row: 3, col: 12 },
            'request.matchAffairsAmount': { row: 3, col: 15 },
            'request.capitalAmount': { row: 4, col: 12 },
            'request.matchCapitalAmount': { row: 4, col: 15 },
            // 申請數小計/總計/比例（來源數值，前端禁止寫入以保護公式）
            'request.totalSubsidy': { row: 5, col: 10, writable: false, reason: '衍生公式欄位' },
            'request.totalMatching': { row: 5, col: 13, writable: false, reason: '衍生公式欄位' },
            'request.total': { row: 6, col: 10, writable: false, reason: '衍生公式欄位' },
            'request.capitalRatio': { row: 9, col: 10, writable: false, reason: '衍生公式欄位' },
            // 申請數範疇 R2 C2-C9
            'request.scope1Subsidy': { row: 2, col: 2 },
            'request.scope1Matching': { row: 2, col: 3 },
            'request.scope2Subsidy': { row: 2, col: 4 },
            'request.scope2Matching': { row: 2, col: 5 },
            'request.scope3Subsidy': { row: 2, col: 6 },
            'request.scope3Matching': { row: 2, col: 7 },
            'request.scope4Subsidy': { row: 2, col: 8 },
            'request.scope4Matching': { row: 2, col: 9 },
            // 執行進度明細 R15-R17
            'execution.personnelAmount': { row: 15, col: 12 },
            'execution.matchPersonnelAmount': { row: 15, col: 15 },
            'execution.affairsAmount': { row: 16, col: 12 },
            'execution.matchAffairsAmount': { row: 16, col: 15 },
            'execution.capitalAmount': { row: 17, col: 12 },
            'execution.matchCapitalAmount': { row: 17, col: 15 },
            // 執行進度小計/總計（來源數值，前端禁止寫入以保護公式）
            'execution.totalSubsidy': { row: 18, col: 10, writable: false, reason: '衍生公式欄位' },
            'execution.totalMatching': { row: 18, col: 13, writable: false, reason: '衍生公式欄位' },
            'execution.total': { row: 19, col: 10, writable: false, reason: '衍生公式欄位' },
            // 執行進度範疇 R15 C2-C9
            'execution.scope1Subsidy': { row: 15, col: 2 },
            'execution.scope1Matching': { row: 15, col: 3 },
            'execution.scope2Subsidy': { row: 15, col: 4 },
            'execution.scope2Matching': { row: 15, col: 5 },
            'execution.scope3Subsidy': { row: 15, col: 6 },
            'execution.scope3Matching': { row: 15, col: 7 },
            'execution.scope4Subsidy': { row: 15, col: 8 },
            'execution.scope4Matching': { row: 15, col: 9 }
        };

        // 可寫入的欄位白名單（簡化版：預設允許，除非明確標記為 writable: false）
        function isWritableField(semanticKey) {
            const mapping = coordMap[semanticKey];
            if (!mapping) return false;
            // 若未指定 writable，預設為 true（允許）
            if (mapping.writable === false) {
                console.warn(`欄位已受保護，不允許寫入: ${semanticKey} (${mapping.reason})`);
                return false;
            }
            return true;
        }
        
        // 資料結構
        let budgetData = {
            // 申請數資料（Row 2）
            request: {
                scope1Subsidy: 15000000,
                scope1Matching: 700000,
                scope2Subsidy: 10000000,
                scope2Matching: 250000,
                scope3Subsidy: 20000000,
                scope3Matching: 3200000,
                scope4Subsidy: 10000000,
                scope4Matching: 1675000,
                permanentStaff: 29162600,
                permanentBusiness: 9337400,
                capital: 16500000,
                permanentMatchingStaff: 335000,
                permanentMatchingBusiness: 1490000,
                capitalMatching: 4000000,
                totalSubsidy: 55000000,
                totalMatching: 5825000,
                total: 60825000,
                capitalRatio: 30
            },
            // 執行數資料（Row 15）
            execution: {
                scope1Subsidy: 1290012,
                scope1Matching: 0,
                scope2Subsidy: 26400,
                scope2Matching: 0,
                scope3Subsidy: 0,
                scope3Matching: 0,
                scope4Subsidy: 1943520,
                scope4Matching: 0,
                permanentStaff: 541503,
                permanentBusiness: 493800,
                capital: 5760,
                permanentMatchingStaff: 0,
                permanentMatchingBusiness: 0,
                capitalMatching: 0,
                totalSubsidy: 1041063,
                totalMatching: 0,
                total: 1041063
            },
            // 執行率（Row 25 和其他）
            rate: {
                scope1: 8.6,
                scope2: 0.264,
                scope3: 0,
                scope4: 19.44,
                permanentStaff: 1.86,
                permanentBusiness: 5.29,
                capital: 0.03,
                total: 1.89,
                matchingTotal: 0
            }
        };

        // 從 CSV 載入資料
        async function loadBudgetDataFromSheet() {
            try {
                const contentSection = document.querySelector('.content-section');
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'alert alert-info';
                loadingMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在載入經費資料...';
                contentSection.prepend(loadingMessage);

                const API_KEY = 'AIzaSyA0JKp0Y8ZmGDHcPEmf4ncaWvnTMtoa8KM';
                const range = encodeURIComponent('深耕計劃經費追蹤表!A1:Q30');
                
                // 添加時間戳避免快取
                const timestamp = new Date().getTime();
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}&t=${timestamp}`;
                
                console.log('正在從 Google Sheets API 載入資料...', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API 錯誤 ${response.status}`);
                }
                
                const data = await response.json();
                const rows = data.values || [];
                
                console.log(`✓ 成功載入 ${rows.length} 列資料`);
                console.log('第一列:', rows[0]);
                console.log('第二列:', rows[1]);
                console.log('第三列:', rows[2]);
                
                // 解析資料
                parseSheetData(rows);
                
                // 更新頁面
                updatePageWithData();
                
                loadingMessage.remove();
                
                console.log('✓ 經費資料已成功載入並更新');
            } catch (error) {
                console.error('❌ 載入經費資料失敗:', error);
                
                // 如果 API 載入失敗，嘗試使用備用資料或通知使用者
                showErrorMessage(error.message);
            }
        }

        // 顯示錯誤訊息並提供使用者指引
        function showErrorMessage(errorMsg) {
            const contentSection = document.querySelector('.content-section');
            const loadingMsg = contentSection.querySelector('.alert-info');
            if (loadingMsg) loadingMsg.remove();
            
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-warning alert-dismissible fade show';
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>資料載入提示</strong><br>
                <small>目前無法即時載入 Google Sheets 資料，頁面顯示預設資料。<br>
                如需更新，請按 F5 刷新頁面或點擊下方「重新載入資料」按鈕。</small>
                <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">重新載入資料</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            contentSection.prepend(errorMessage);
            
            // 保留預設資料顯示
            updatePageWithData();
        }

        // 解析 CSV 資料
        function parseSheetData(rows) {
            try {
                console.log('開始解析資料...');
                
                if (rows.length < 3) {
                    console.warn('⚠️ 資料不足，使用預設值');
                    return;
                }
                
                const parseNum = (str) => {
                    if (!str) return 0;
                    // 處理各種數字格式：15000000, "15,000,000", "15 000 000" 等
                    const cleaned = String(str).replace(/[,\s"]/g, '');
                    return parseInt(cleaned) || 0;
                };
                
                // 資料結構：
                // R0: 標題 [範疇, , 範疇一, , 範疇二, , 範疇三, , 範疇四, , 總計(G), , , , ]
                // R1: 子標題 [申請數, 第一階段, 補助款, 配合款, ...]
                // R2: 申請數資料
                
                console.log('R2 欄位:', rows[2]);
                
                // 解析申請數（R2）
                // 欄位位置：C0=空, C1=空, C2=範疇一補助, C3=範疇一配合, C4=範疇二補助...
                if (rows[2] && rows[2].length >= 11) {
                    const req = rows[2];
                    
                    budgetData.request.scope1Subsidy = parseNum(req[2]);
                    budgetData.request.scope1Matching = parseNum(req[3]);
                    budgetData.request.scope2Subsidy = parseNum(req[4]);
                    budgetData.request.scope2Matching = parseNum(req[5]);
                    budgetData.request.scope3Subsidy = parseNum(req[6]);
                    budgetData.request.scope3Matching = parseNum(req[7]);
                    budgetData.request.scope4Subsidy = parseNum(req[8]);
                    budgetData.request.scope4Matching = parseNum(req[9]);
                    
                    console.log('✓ 申請數解析:', {
                        scope1Subsidy: budgetData.request.scope1Subsidy,
                        scope2Subsidy: budgetData.request.scope2Subsidy
                    });
                }
                
                // 解析總補助款（R5, C10）
                if (rows[5] && rows[5][10] !== undefined) {
                    budgetData.request.totalSubsidy = parseNum(rows[5][10]);
                    console.log('✓ 總補助款:', budgetData.request.totalSubsidy);
                }
                
                // 解析總經費（R6, C10）
                if (rows[6] && rows[6][10] !== undefined) {
                    budgetData.request.total = parseNum(rows[6][10]);
                    console.log('✓ 總經費:', budgetData.request.total);
                }
                
                // 解析申請數配合款（R5, C13）
                if (rows[5] && rows[5][13] !== undefined) {
                    budgetData.request.totalMatching = parseNum(rows[5][13]);
                    console.log('✓ 申請數配合款(F):', budgetData.request.totalMatching);
                }
                
                // 資本門比例 (R9, C10)
                if (rows[9] && rows[9][10]) {
                    budgetData.request.capitalRatio = parseFloat(String(rows[9][10]).replace('%', '')) || 30;
                    console.log('✓ 資本門比例:', budgetData.request.capitalRatio + '%');
                }
                
                // 解析申請數明細（經常門人事費、業務費、資本門等）
                // R2: C12=人事費金額, C15=配合款人事費
                // R3: C12=業務費金額, C15=配合款業務費
                // R4: C12=資本門金額, C15=配合款資本門
                if (rows[2] && rows[2].length >= 13) {
                    budgetData.request.personnelAmount = parseNum(rows[2][12]) || 0;  // R2 C12
                    budgetData.request.matchPersonnelAmount = parseNum(rows[2][15]) || 0;  // R2 C15
                    console.log('✓ 人事費:', budgetData.request.personnelAmount, '配合款:', budgetData.request.matchPersonnelAmount);
                }
                
                if (rows[3] && rows[3].length >= 13) {
                    budgetData.request.affairsAmount = parseNum(rows[3][12]) || 0;  // R3 C12
                    budgetData.request.matchAffairsAmount = parseNum(rows[3][15]) || 0;  // R3 C15
                    console.log('✓ 業務費:', budgetData.request.affairsAmount, '配合款:', budgetData.request.matchAffairsAmount);
                }
                
                if (rows[4] && rows[4].length >= 13) {
                    budgetData.request.capitalAmount = parseNum(rows[4][12]) || 0;  // R4 C12
                    budgetData.request.matchCapitalAmount = parseNum(rows[4][15]) || 0;  // R4 C15
                    console.log('✓ 資本門:', budgetData.request.capitalAmount, '配合款:', budgetData.request.matchCapitalAmount);
                }
                
                // 執行進度表通常在 R14(標題) 和 R15(數據)
                // 不依賴於「執行」標籤，直接使用固定行號
                // R15-R17: 經常門、業務費、資本門明細
                // R18: 總計行
                
                // 執行進度明細（R15-R17）
                if (rows[15] && rows[15].length >= 13) {
                    budgetData.execution.personnelAmount = parseNum(rows[15][12]) || 0;  // R15 C12
                    if (rows[15].length >= 16) {
                        budgetData.execution.matchPersonnelAmount = parseNum(rows[15][15]) || 0;  // R15 C15
                    }
                    console.log('✓ 執行進度人事費:', budgetData.execution.personnelAmount, '配合款:', budgetData.execution.matchPersonnelAmount, '原始值:', rows[15][15]);
                }
                if (rows[16] && rows[16].length >= 13) {
                    budgetData.execution.affairsAmount = parseNum(rows[16][12]) || 0;  // R16 C12
                    if (rows[16].length >= 16) {
                        budgetData.execution.matchAffairsAmount = parseNum(rows[16][15]) || 0;  // R16 C15
                    }
                    console.log('✓ 執行進度業務費:', budgetData.execution.affairsAmount, '配合款:', budgetData.execution.matchAffairsAmount, '原始值:', rows[16][15]);
                }
                if (rows[17] && rows[17].length >= 13) {
                    budgetData.execution.capitalAmount = parseNum(rows[17][12]) || 0;  // R17 C12
                    if (rows[17].length >= 16) {
                        budgetData.execution.matchCapitalAmount = parseNum(rows[17][15]) || 0;  // R17 C15
                    }
                    console.log('✓ 執行進度資本門:', budgetData.execution.capitalAmount, '配合款:', budgetData.execution.matchCapitalAmount, '原始值:', rows[17][15]);
                }
                
                // 執行進度總計（R18 C10=總補助款, C13=配合款；R19 C10=總計）
                if (rows[18] && rows[18].length >= 11) {
                    budgetData.execution.totalSubsidy = parseNum(rows[18][10]);
                    if (rows[18][13] !== undefined) {
                        budgetData.execution.totalMatching = parseNum(rows[18][13]);
                    }
                    console.log('✓ 執行進度小計:', budgetData.execution.totalSubsidy);
                }
                if (rows[19] && rows[19].length >= 11) {
                    budgetData.execution.total = parseNum(rows[19][10]);
                    console.log('✓ 執行進度總計:', budgetData.execution.total);
                }
                
                let executionRowIdx = -1;
                for (let i = 10; i < rows.length; i++) {
                    if (rows[i][0] && String(rows[i][0]).includes('執行')) {
                        executionRowIdx = i;
                        break;
                    }
                }
                
                console.log('執行進度資料已從固定行號解析');
                
                // 解析執行數範疇（第一段表）（R15 C2-C9）
                if (rows[15] && rows[15].length >= 10) {
                    budgetData.execution.scope1Subsidy = parseNum(rows[15][2]);
                    budgetData.execution.scope1Matching = parseNum(rows[15][3]);
                    budgetData.execution.scope2Subsidy = parseNum(rows[15][4]);
                    budgetData.execution.scope2Matching = parseNum(rows[15][5]);
                    budgetData.execution.scope3Subsidy = parseNum(rows[15][6]);
                    budgetData.execution.scope3Matching = parseNum(rows[15][7]);
                    budgetData.execution.scope4Subsidy = parseNum(rows[15][8]);
                    budgetData.execution.scope4Matching = parseNum(rows[15][9]);
                    
                    console.log('✓ 執行數範疇已解析:', {
                        scope1Subsidy: budgetData.execution.scope1Subsidy,
                        scope2Subsidy: budgetData.execution.scope2Subsidy
                    });
                }
                
                // 計算執行率
                budgetData.rate.scope1 = budgetData.request.scope1Subsidy > 0 
                    ? (budgetData.execution.scope1Subsidy / budgetData.request.scope1Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.scope2 = budgetData.request.scope2Subsidy > 0 
                    ? (budgetData.execution.scope2Subsidy / budgetData.request.scope2Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.scope3 = budgetData.request.scope3Subsidy > 0 
                    ? (budgetData.execution.scope3Subsidy / budgetData.request.scope3Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.scope4 = budgetData.request.scope4Subsidy > 0 
                    ? (budgetData.execution.scope4Subsidy / budgetData.request.scope4Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.total = budgetData.request.totalSubsidy > 0 
                    ? (budgetData.execution.totalSubsidy / budgetData.request.totalSubsidy * 100).toFixed(2)
                    : 0;
                
                console.log('✓ 資料解析完成:', budgetData);
                
            } catch (e) {
                console.error('資料解析錯誤:', e);
                console.error('堆棧:', e.stack);
            }
        }

        // 更新頁面顯示
        function updatePageWithData() {
            // 格式化數字
            const fmt = (num) => Math.round(num).toLocaleString('en-US');
            
            console.log('開始更新頁面，budgetData:', budgetData);
            
            // 更新卡片（用 ID 選擇器）
            const el = {
                cardTotalSubsidy: document.getElementById('cardTotalSubsidy'),
                cardTotalMatching: document.getElementById('cardTotalMatching'),
                cardTotal: document.getElementById('cardTotal'),
                cardCapitalRatio: document.getElementById('cardCapitalRatio'),
                totalSubsidyCell: document.getElementById('totalSubsidyCell'),
                totalMatchingCell: document.getElementById('totalMatchingCell'),
                totalCell: document.getElementById('totalCell'),
                execTotalSubsidyCell: document.getElementById('execTotalSubsidyCell'),
                execTotalMatchingCell: document.getElementById('execTotalMatchingCell'),
                execTotalCell: document.getElementById('execTotalCell')
            };
            
            if (el.cardTotalSubsidy) el.cardTotalSubsidy.textContent = budgetData.request.totalSubsidy > 0 ? fmt(budgetData.request.totalSubsidy) : '-';
            if (el.cardTotalMatching) el.cardTotalMatching.textContent = budgetData.request.totalMatching > 0 ? fmt(budgetData.request.totalMatching) : '-';
            if (el.cardTotal) el.cardTotal.textContent = budgetData.request.total > 0 ? fmt(budgetData.request.total) : '-';
            if (el.cardCapitalRatio) el.cardCapitalRatio.textContent = budgetData.request.capitalRatio > 0 ? budgetData.request.capitalRatio + '%' : '-';
            
            // 更新小計欄位
            if (el.totalSubsidyCell) el.totalSubsidyCell.textContent = budgetData.request.totalSubsidy > 0 ? fmt(budgetData.request.totalSubsidy) : '-';
            if (el.totalMatchingCell) el.totalMatchingCell.textContent = budgetData.request.totalMatching > 0 ? fmt(budgetData.request.totalMatching) : '-';
            if (el.totalCell) el.totalCell.textContent = budgetData.request.total > 0 ? fmt(budgetData.request.total) : '-';
            if (el.execTotalSubsidyCell) el.execTotalSubsidyCell.textContent = budgetData.execution.totalSubsidy > 0 ? fmt(budgetData.execution.totalSubsidy) : '-';
            if (el.execTotalMatchingCell) el.execTotalMatchingCell.textContent = budgetData.execution.totalMatching > 0 ? fmt(budgetData.execution.totalMatching) : '-';
            if (el.execTotalCell) el.execTotalCell.textContent = budgetData.execution.total > 0 ? fmt(budgetData.execution.total) : '-';
            
            console.log('卡片已更新');
            
            // 更新申請數明細欄位
            updateRequestDetails();
            
            // 更新申請數表格
            updateRequestTable();
            
            // 更新執行數表格
            updateExecutionTable();
            
            // 更新執行數明細欄位
            updateExecutionDetails();
            
            // 更新進度百分比表
            updateRateTable();
            
            // 更新進度條
            updateProgressBars();
            
            console.log('✓ 頁面已完全更新');
        }

        // 更新申請數表格
        function updateRequestTable() {
            const fmt = (num) => Math.round(num).toLocaleString('en-US');
            
            // 用 class 選擇器直接更新
            const cells = {
                scope1Subsidy: document.querySelector('.scope1-subsidy'),
                scope1Matching: document.querySelector('.scope1-matching'),
                scope2Subsidy: document.querySelector('.scope2-subsidy'),
                scope2Matching: document.querySelector('.scope2-matching'),
                scope3Subsidy: document.querySelector('.scope3-subsidy'),
                scope3Matching: document.querySelector('.scope3-matching'),
                scope4Subsidy: document.querySelector('.scope4-subsidy'),
                scope4Matching: document.querySelector('.scope4-matching')
            };
            
            if (cells.scope1Subsidy) cells.scope1Subsidy.textContent = budgetData.request.scope1Subsidy > 0 ? fmt(budgetData.request.scope1Subsidy) : '-';
            if (cells.scope1Matching) cells.scope1Matching.textContent = budgetData.request.scope1Matching > 0 ? fmt(budgetData.request.scope1Matching) : '-';
            if (cells.scope2Subsidy) cells.scope2Subsidy.textContent = budgetData.request.scope2Subsidy > 0 ? fmt(budgetData.request.scope2Subsidy) : '-';
            if (cells.scope2Matching) cells.scope2Matching.textContent = budgetData.request.scope2Matching > 0 ? fmt(budgetData.request.scope2Matching) : '-';
            if (cells.scope3Subsidy) cells.scope3Subsidy.textContent = budgetData.request.scope3Subsidy > 0 ? fmt(budgetData.request.scope3Subsidy) : '-';
            if (cells.scope3Matching) cells.scope3Matching.textContent = budgetData.request.scope3Matching > 0 ? fmt(budgetData.request.scope3Matching) : '-';
            if (cells.scope4Subsidy) cells.scope4Subsidy.textContent = budgetData.request.scope4Subsidy > 0 ? fmt(budgetData.request.scope4Subsidy) : '-';
            if (cells.scope4Matching) cells.scope4Matching.textContent = budgetData.request.scope4Matching > 0 ? fmt(budgetData.request.scope4Matching) : '-';
            
            console.log('✓ 申請數表格已更新');
        }

        // 更新申請數明細欄位
        function updateRequestDetails() {
            const fmt = (num) => {
                // num 可能是 undefined/null，才是「無法取得」
                // 0 是有效數據，應顯示 0
                if (num === undefined || num === null || num === '') return '無法取得';
                return Math.round(num).toLocaleString('en-US');
            };
            
            const cells = {
                requestPersonnel: document.getElementById('requestPersonnelCell'),
                matchPersonnel: document.getElementById('matchPersonnelCell'),
                requestAffairs: document.getElementById('requestAffairsCell'),
                matchAffairs: document.getElementById('matchAffairsCell'),
                requestCapital: document.getElementById('requestCapitalCell'),
                matchCapital: document.getElementById('matchCapitalCell')
            };
            
            if (cells.requestPersonnel) cells.requestPersonnel.textContent = fmt(budgetData.request.personnelAmount);
            if (cells.matchPersonnel) cells.matchPersonnel.textContent = fmt(budgetData.request.matchPersonnelAmount);
            if (cells.requestAffairs) cells.requestAffairs.textContent = fmt(budgetData.request.affairsAmount);
            if (cells.matchAffairs) cells.matchAffairs.textContent = fmt(budgetData.request.matchAffairsAmount);
            if (cells.requestCapital) cells.requestCapital.textContent = fmt(budgetData.request.capitalAmount);
            if (cells.matchCapital) cells.matchCapital.textContent = fmt(budgetData.request.matchCapitalAmount);
            
            console.log('✓ 申請數明細已更新');
        }

        // 更新執行數明細欄位
        function updateExecutionDetails() {
            const fmt = (num) => {
                // num 可能是 undefined/null，才是「無法取得」
                // 0 是有效數據，應顯示 0
                if (num === undefined || num === null || num === '') return '無法取得';
                return Math.round(num).toLocaleString('en-US');
            };
            
            const cells = {
                execPersonnel: document.getElementById('execPersonnelCell'),
                execMatchPersonnel: document.getElementById('execMatchPersonnelCell'),
                execAffairs: document.getElementById('execAffairsCell'),
                execMatchAffairs: document.getElementById('execMatchAffairsCell'),
                execCapital: document.getElementById('execCapitalCell'),
                execMatchCapital: document.getElementById('execMatchCapitalCell'),
                execTotalSubsidy: document.getElementById('execTotalSubsidyCell'),
                execTotalMatching: document.getElementById('execTotalMatchingCell'),
                execTotal: document.getElementById('execTotalCell')
            };
            
            if (cells.execPersonnel) cells.execPersonnel.textContent = fmt(budgetData.execution.personnelAmount);
            if (cells.execMatchPersonnel) cells.execMatchPersonnel.textContent = fmt(budgetData.execution.matchPersonnelAmount);
            if (cells.execAffairs) cells.execAffairs.textContent = fmt(budgetData.execution.affairsAmount);
            if (cells.execMatchAffairs) cells.execMatchAffairs.textContent = fmt(budgetData.execution.matchAffairsAmount);
            if (cells.execCapital) cells.execCapital.textContent = fmt(budgetData.execution.capitalAmount);
            if (cells.execMatchCapital) cells.execMatchCapital.textContent = fmt(budgetData.execution.matchCapitalAmount);
            if (cells.execTotalSubsidy) cells.execTotalSubsidy.textContent = fmt(budgetData.execution.totalSubsidy);
            if (cells.execTotalMatching) cells.execTotalMatching.textContent = fmt(budgetData.execution.totalMatching);
            if (cells.execTotal) cells.execTotal.textContent = fmt(budgetData.execution.total);
            
            console.log('✓ 執行數明細已更新', {
                personnel: budgetData.execution.personnelAmount,
                affairs: budgetData.execution.affairsAmount,
                capital: budgetData.execution.capitalAmount,
                totalSubsidy: budgetData.execution.totalSubsidy,
                totalMatching: budgetData.execution.totalMatching,
                total: budgetData.execution.total
            });
        }

        // 更新執行數表格
        function updateExecutionTable() {
            const fmt = (num) => Math.round(num).toLocaleString('en-US');
            
            const cells = {
                scope1Subsidy: document.querySelector('.exec-scope1-subsidy'),
                scope1Matching: document.querySelector('.exec-scope1-matching'),
                scope2Subsidy: document.querySelector('.exec-scope2-subsidy'),
                scope2Matching: document.querySelector('.exec-scope2-matching'),
                scope3Subsidy: document.querySelector('.exec-scope3-subsidy'),
                scope3Matching: document.querySelector('.exec-scope3-matching'),
                scope4Subsidy: document.querySelector('.exec-scope4-subsidy'),
                scope4Matching: document.querySelector('.exec-scope4-matching')
            };
            
            if (cells.scope1Subsidy) cells.scope1Subsidy.textContent = budgetData.execution.scope1Subsidy > 0 ? fmt(budgetData.execution.scope1Subsidy) : '-';
            if (cells.scope1Matching) cells.scope1Matching.textContent = budgetData.execution.scope1Matching > 0 ? fmt(budgetData.execution.scope1Matching) : '-';
            if (cells.scope2Subsidy) cells.scope2Subsidy.textContent = budgetData.execution.scope2Subsidy > 0 ? fmt(budgetData.execution.scope2Subsidy) : '-';
            if (cells.scope2Matching) cells.scope2Matching.textContent = budgetData.execution.scope2Matching > 0 ? fmt(budgetData.execution.scope2Matching) : '-';
            if (cells.scope3Subsidy) cells.scope3Subsidy.textContent = budgetData.execution.scope3Subsidy > 0 ? fmt(budgetData.execution.scope3Subsidy) : '-';
            if (cells.scope3Matching) cells.scope3Matching.textContent = budgetData.execution.scope3Matching > 0 ? fmt(budgetData.execution.scope3Matching) : '-';
            if (cells.scope4Subsidy) cells.scope4Subsidy.textContent = budgetData.execution.scope4Subsidy > 0 ? fmt(budgetData.execution.scope4Subsidy) : '-';
            if (cells.scope4Matching) cells.scope4Matching.textContent = budgetData.execution.scope4Matching > 0 ? fmt(budgetData.execution.scope4Matching) : '-';
            
            console.log('✓ 執行數表格已更新');
        }

        // 更新進度百分比表
        function updateRateTable() {
            const tables = document.querySelectorAll('.budget-table');
            if (tables.length > 2) {
                const thirdTable = tables[2];
                const rows = thirdTable.querySelectorAll('tbody tr');
                
                if (rows.length > 0) {
                    const firstDataRow = rows[0];
                    const cells = firstDataRow.querySelectorAll('td.percentage-cell');
                    
                    if (cells.length >= 8) {
                        cells[0].textContent = budgetData.rate.scope1 + '%';
                        cells[1].textContent = '0%'; // 配合款
                        cells[2].textContent = budgetData.rate.scope2 + '%';
                        cells[3].textContent = '0%'; // 配合款
                        cells[4].textContent = budgetData.rate.scope3 + '%';
                        cells[5].textContent = '0%'; // 配合款
                        cells[6].textContent = budgetData.rate.scope4 + '%';
                        cells[7].textContent = '0%'; // 配合款
                        
                        console.log('✓ 執行率表格已更新');
                    }
                }
            }
        }

        // 更新進度條
        function updateProgressBars() {
            const items = [
                { selector: '[style*="width: 8.6%"]', rate: budgetData.rate.scope1, label: `${budgetData.rate.scope1}% (${budgetData.execution.scope1Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope1Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 0.26%"]', rate: budgetData.rate.scope2, label: `${budgetData.rate.scope2}% (${budgetData.execution.scope2Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope2Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 0%"]', rate: budgetData.rate.scope3, label: `${budgetData.rate.scope3}% (${budgetData.execution.scope3Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope3Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 19.44%"]', rate: budgetData.rate.scope4, label: `${budgetData.rate.scope4}% (${budgetData.execution.scope4Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope4Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 1.89%"]', rate: budgetData.rate.total, label: `${budgetData.rate.total}% (${budgetData.execution.totalSubsidy.toLocaleString('en-US')} / ${budgetData.request.totalSubsidy.toLocaleString('en-US')})` }
            ];
            
            const progressBars = document.querySelectorAll('.progress-bar-fill');
            progressBars.forEach((bar, idx) => {
                if (idx < items.length) {
                    const rate = Math.min(items[idx].rate, 100);
                    bar.style.width = rate + '%';
                }
            });
            
            const smallTexts = document.querySelectorAll('.progress-item small');
            smallTexts.forEach((text, idx) => {
                if (idx < items.length) {
                    text.textContent = items[idx].label;
                }
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded: 開始載入經費資料...');
            
            // 先檢查本地儲存
            loadSavedData();
            
            // 先顯示預設資料（立即可見）
            updatePageWithData();
            
            // 異步載入 Google Sheets 資料（如果成功則覆蓋預設值）
            setTimeout(() => {
                loadBudgetDataFromSheet();
            }, 500);
        });

        function printReport() {
            window.print();
        }

        function showUpdateReminder() {
            const lastUpdate = localStorage.getItem('budgetLastUpdate');
            const now = new Date().getTime();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;
            
            if (!lastUpdate || now - lastUpdate > oneWeek) {
                const reminder = document.createElement('div');
                reminder.className = 'alert alert-warning alert-dismissible fade show';
                reminder.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    提醒：建議定期更新經費追蹤數據以確保資訊準確性
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.content-section').prepend(reminder);
            }
        }

        window.onload = function() {
            showUpdateReminder();
            console.log('深耕計劃經費追蹤表載入完成');
        };

        // 切換編輯模式
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const banner = document.getElementById('editModeBanner');
            const saveBtn = document.getElementById('saveChangesBtn');
            const editBtnText = document.getElementById('editBtnText');
            
            if (isEditMode) {
                // 啟用編輯模式
                banner.style.display = 'block';
                editBtnText.textContent = '關閉編輯模式';
                originalData = JSON.parse(JSON.stringify(budgetData));
                modifiedCells.clear();
                
                // 為所有可編輯的儲存格添加點擊事件
                enableEditableCells();
                
                console.log('✓ 編輯模式已啟用');
            } else {
                // 關閉編輯模式
                banner.style.display = 'none';
                saveBtn.style.display = 'none';
                editBtnText.textContent = '啟用編輯模式';
                
                // 移除所有編輯相關的class和事件
                disableEditableCells();
                
                console.log('✓ 編輯模式已關閉');
            }
        }

        // 啟用可編輯儲存格
        function enableEditableCells() {
            // 為所有數字儲存格添加editable-cell class
            const cells = document.querySelectorAll('.amount-cell');
            cells.forEach(cell => {
                if (!cell.classList.contains('editable-cell')) {
                    cell.classList.add('editable-cell');
                    cell.addEventListener('click', handleCellClick);
                }
            });
        }

        // 停用可編輯儲存格
        function disableEditableCells() {
            const cells = document.querySelectorAll('.editable-cell');
            cells.forEach(cell => {
                cell.classList.remove('editable-cell');
                cell.removeEventListener('click', handleCellClick);
            });
        }

        // 處理儲存格點擊
        function handleCellClick(event) {
            if (!isEditMode) return;
            
            const cell = event.currentTarget;
            const cellId = cell.id;
            
            // 檢查是否為可寫入欄位（若有 ID 則驗證）
            if (cellId) {
                let semanticKey = null;
                if (cellId === 'totalSubsidyCell') semanticKey = 'request.totalSubsidy';
                else if (cellId === 'totalMatchingCell') semanticKey = 'request.totalMatching';
                else if (cellId === 'totalCell') semanticKey = 'request.total';
                else if (cellId === 'execTotalSubsidyCell') semanticKey = 'execution.totalSubsidy';
                else if (cellId === 'execTotalMatchingCell') semanticKey = 'execution.totalMatching';
                else if (cellId === 'execTotalCell') semanticKey = 'execution.total';
                
                if (semanticKey && !isWritableField(semanticKey)) {
                    alert(`此欄位為衍生公式欄位，不允許直接編輯。\n請修改來源數值（人事費、業務費、資本門等）。`);
                    return;
                }
            }
            
            const currentValue = cell.textContent.replace(/[,\s]/g, '');
            
            // 如果已經是輸入框,不再創建
            if (cell.querySelector('input')) return;
            
            // 創建輸入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'cell-input';
            input.value = currentValue === '-' || currentValue === '無法取得' ? '' : currentValue;
            
            // 保存原始內容
            const originalContent = cell.innerHTML;
            
            // 替換為輸入框
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            // 處理輸入完成
            const finishEdit = () => {
                const newValue = input.value.trim();
                
                if (newValue === '') {
                    // 空值恢復原內容
                    cell.innerHTML = originalContent;
                } else {
                    const numValue = parseInt(newValue);
                    if (isNaN(numValue)) {
                        alert('請輸入有效的數字');
                        cell.innerHTML = originalContent;
                    } else {
                        // 更新顯示
                        cell.textContent = numValue.toLocaleString('en-US');
                        
                        // 記錄修改
                        const cellId = cell.id || cell.className;
                        modifiedCells.set(cellId, {
                            element: cell,
                            oldValue: currentValue,
                            newValue: numValue,
                            originalContent: originalContent
                        });
                        
                        // 更新 budgetData
                        updateBudgetData(cell, numValue);
                        
                        // 顯示保存按鈕
                        document.getElementById('saveChangesBtn').style.display = 'block';
                        
                        console.log(`✓ 儲存格已修改: ${cellId} = ${numValue}`);
                    }
                }
            };
            
            // 按Enter或失去焦點時完成編輯
            input.addEventListener('blur', finishEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    finishEdit();
                }
            });
        }

        // 更新 budgetData 物件
        function updateBudgetData(cell, newValue) {
            const cellId = cell.id;
            const cellClass = cell.className;
            
            // 根據 ID 或 class 更新對應的資料
            if (cellId.includes('request')) {
                if (cellId.includes('Personnel')) budgetData.request.personnelAmount = newValue;
                else if (cellId.includes('Affairs')) budgetData.request.affairsAmount = newValue;
                else if (cellId.includes('Capital')) budgetData.request.capitalAmount = newValue;
            } else if (cellId.includes('match')) {
                if (cellId.includes('Personnel')) budgetData.request.matchPersonnelAmount = newValue;
                else if (cellId.includes('Affairs')) budgetData.request.matchAffairsAmount = newValue;
                else if (cellId.includes('Capital')) budgetData.request.matchCapitalAmount = newValue;
            } else if (cellId.includes('exec')) {
                if (cellId.includes('Personnel')) budgetData.execution.personnelAmount = newValue;
                else if (cellId.includes('Affairs')) budgetData.execution.affairsAmount = newValue;
                else if (cellId.includes('Capital')) budgetData.execution.capitalAmount = newValue;
                else if (cellId.includes('TotalSubsidy')) budgetData.execution.totalSubsidy = newValue;
                else if (cellId.includes('TotalMatching')) budgetData.execution.totalMatching = newValue;
                else if (cellId.includes('Total')) budgetData.execution.total = newValue;
            } else if (cellClass.includes('scope')) {
                // 處理範疇資料
                if (cellClass.includes('scope1-subsidy')) budgetData.request.scope1Subsidy = newValue;
                else if (cellClass.includes('scope1-matching')) budgetData.request.scope1Matching = newValue;
                else if (cellClass.includes('scope2-subsidy')) budgetData.request.scope2Subsidy = newValue;
                else if (cellClass.includes('scope2-matching')) budgetData.request.scope2Matching = newValue;
                else if (cellClass.includes('scope3-subsidy')) budgetData.request.scope3Subsidy = newValue;
                else if (cellClass.includes('scope3-matching')) budgetData.request.scope3Matching = newValue;
                else if (cellClass.includes('scope4-subsidy')) budgetData.request.scope4Subsidy = newValue;
                else if (cellClass.includes('scope4-matching')) budgetData.request.scope4Matching = newValue;
                else if (cellClass.includes('exec-scope1-subsidy')) budgetData.execution.scope1Subsidy = newValue;
                else if (cellClass.includes('exec-scope1-matching')) budgetData.execution.scope1Matching = newValue;
                else if (cellClass.includes('exec-scope2-subsidy')) budgetData.execution.scope2Subsidy = newValue;
                else if (cellClass.includes('exec-scope2-matching')) budgetData.execution.scope2Matching = newValue;
                else if (cellClass.includes('exec-scope3-subsidy')) budgetData.execution.scope3Subsidy = newValue;
                else if (cellClass.includes('exec-scope3-matching')) budgetData.execution.scope3Matching = newValue;
                else if (cellClass.includes('exec-scope4-subsidy')) budgetData.execution.scope4Subsidy = newValue;
                else if (cellClass.includes('exec-scope4-matching')) budgetData.execution.scope4Matching = newValue;
            }
        }

        // 保存變更
        function saveChanges() {
            if (modifiedCells.size === 0) {
                alert('沒有需要保存的變更');
                return;
            }
            
            // 顯示確認對話框
            const changesList = Array.from(modifiedCells.entries())
                .map(([cellId, data]) => `${cellId}: ${data.oldValue} → ${data.newValue}`)
                .join('\n');
            
            const confirmed = confirm(`確定要保存以下變更嗎?\n\n${changesList}\n\n注意：這些變更只會在瀏覽器中保存，不會同步到Google Sheets。`);
            
            if (!confirmed) return;

            // 僅提交實際修改過的欄位：由 modifiedCells 生成 payload
            const changes = [];
            for (const [cellId, data] of modifiedCells.entries()) {
                // 解析語義鍵或依 ID/class 推斷對應欄位
                let semanticKey = null;
                const cls = data.element.className || '';
                const id = data.element.id || '';

                // 由 id 推斷（優先）
                if (id === 'requestPersonnelCell') semanticKey = 'request.personnelAmount';
                else if (id === 'matchPersonnelCell') semanticKey = 'request.matchPersonnelAmount';
                else if (id === 'requestAffairsCell') semanticKey = 'request.affairsAmount';
                else if (id === 'matchAffairsCell') semanticKey = 'request.matchAffairsAmount';
                else if (id === 'requestCapitalCell') semanticKey = 'request.capitalAmount';
                else if (id === 'matchCapitalCell') semanticKey = 'request.matchCapitalAmount';
                else if (id === 'totalSubsidyCell') semanticKey = 'request.totalSubsidy';
                else if (id === 'totalMatchingCell') semanticKey = 'request.totalMatching';
                else if (id === 'totalCell') semanticKey = 'request.total';
                else if (id === 'execTotalSubsidyCell') semanticKey = 'execution.totalSubsidy';
                else if (id === 'execTotalMatchingCell') semanticKey = 'execution.totalMatching';
                else if (id === 'execTotalCell') semanticKey = 'execution.total';
                else if (id === 'execPersonnelCell') semanticKey = 'execution.personnelAmount';
                else if (id === 'execMatchPersonnelCell') semanticKey = 'execution.matchPersonnelAmount';
                else if (id === 'execAffairsCell') semanticKey = 'execution.affairsAmount';
                else if (id === 'execMatchAffairsCell') semanticKey = 'execution.matchAffairsAmount';
                else if (id === 'execCapitalCell') semanticKey = 'execution.capitalAmount';
                else if (id === 'execMatchCapitalCell') semanticKey = 'execution.matchCapitalAmount';
                
                // 由 class 推斷（範疇）
                if (!semanticKey) {
                    if (cls.includes('scope1-subsidy')) semanticKey = 'request.scope1Subsidy';
                    else if (cls.includes('scope1-matching')) semanticKey = 'request.scope1Matching';
                    else if (cls.includes('scope2-subsidy')) semanticKey = 'request.scope2Subsidy';
                    else if (cls.includes('scope2-matching')) semanticKey = 'request.scope2Matching';
                    else if (cls.includes('scope3-subsidy')) semanticKey = 'request.scope3Subsidy';
                    else if (cls.includes('scope3-matching')) semanticKey = 'request.scope3Matching';
                    else if (cls.includes('scope4-subsidy')) semanticKey = 'request.scope4Subsidy';
                    else if (cls.includes('scope4-matching')) semanticKey = 'request.scope4Matching';
                    else if (cls.includes('exec-scope1-subsidy')) semanticKey = 'execution.scope1Subsidy';
                    else if (cls.includes('exec-scope1-matching')) semanticKey = 'execution.scope1Matching';
                    else if (cls.includes('exec-scope2-subsidy')) semanticKey = 'execution.scope2Subsidy';
                    else if (cls.includes('exec-scope2-matching')) semanticKey = 'execution.scope2Matching';
                    else if (cls.includes('exec-scope3-subsidy')) semanticKey = 'execution.scope3Subsidy';
                    else if (cls.includes('exec-scope3-matching')) semanticKey = 'execution.scope3Matching';
                    else if (cls.includes('exec-scope4-subsidy')) semanticKey = 'execution.scope4Subsidy';
                    else if (cls.includes('exec-scope4-matching')) semanticKey = 'execution.scope4Matching';
                }

                if (!semanticKey) {
                    console.warn('無法辨識修改的欄位對應:', cellId);
                    continue;
                }

                // 白名單檢查：禁止寫入衍生公式欄位
                if (!isWritableField(semanticKey)) {
                    console.warn(`跳過受保護欄位: ${semanticKey}`);
                    continue;
                }

                const mapping = coordMap[semanticKey];
                if (!mapping) {
                    console.warn('缺少座標對映:', semanticKey);
                    continue;
                }

                changes.push({ row: mapping.row, col: mapping.col, value: data.newValue });
            }

            // 若使用者只改了部分儲存格，也保留全部語義欄位寫入，確保一致性
            const payload = {
                sheetName: '深耕計劃經費追蹤表',
                changes,
                token: localStorage.getItem('budgetSyncToken') || ''
            };

            // 若未設定 Web App URL，先提示設定再僅本地保存
            if (!WEB_APP_URL) {
                alert('尚未設定同步目的地（Apps Script Web App URL）。僅保存到本地瀏覽器。\n請在部署後按下列步驟設定同步 URL。');
            }

            // 先保存到本地
            localStorage.setItem('budgetData', JSON.stringify(budgetData));
            localStorage.setItem('budgetLastModified', new Date().toISOString());

            // 重新計算執行率
            budgetData.rate.scope1 = budgetData.request.scope1Subsidy > 0 
                ? (budgetData.execution.scope1Subsidy / budgetData.request.scope1Subsidy * 100).toFixed(2)
                : 0;
            budgetData.rate.scope2 = budgetData.request.scope2Subsidy > 0 
                ? (budgetData.execution.scope2Subsidy / budgetData.request.scope2Subsidy * 100).toFixed(2)
                : 0;
            budgetData.rate.scope3 = budgetData.request.scope3Subsidy > 0 
                ? (budgetData.execution.scope3Subsidy / budgetData.request.scope3Subsidy * 100).toFixed(2)
                : 0;
            budgetData.rate.scope4 = budgetData.request.scope4Subsidy > 0 
                ? (budgetData.execution.scope4Subsidy / budgetData.request.scope4Subsidy * 100).toFixed(2)
                : 0;
            budgetData.rate.total = budgetData.request.totalSubsidy > 0 
                ? (budgetData.execution.totalSubsidy / budgetData.request.totalSubsidy * 100).toFixed(2)
                : 0;

            // 更新頁面顯示
            updatePageWithData();

            // 嘗試同步到 Apps Script（若已設定 URL）
            (async () => {
                if (!WEB_APP_URL) {
                    console.log('未設定 Web App URL，略過遠端同步');
                    alert('本地保存完成。設定同步 URL 後即可寫入 Google Sheets。');
                    modifiedCells.clear();
                    document.getElementById('saveChangesBtn').style.display = 'none';
                    return;
                }
                try {
                    // 同步狀態提示
                    const saveBtn = document.getElementById('saveChangesBtn');
                    const originalBtnHTML = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>同步中...';
                    saveBtn.disabled = true;

                    const res = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const json = await res.json();
                    if (json.ok) {
                        alert('同步成功（Google Sheets 已更新）');
                        console.log('✓ 遠端同步成功');
                        modifiedCells.clear();
                        document.getElementById('saveChangesBtn').style.display = 'none';
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalBtnHTML;
                    } else {
                        throw new Error(json.error || 'unknown error');
                    }
                } catch (err) {
                    console.error('同步失敗:', err);
                    alert('同步失敗，已保留本地保存。可稍後重試。');
                    const saveBtn = document.getElementById('saveChangesBtn');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>保存變更';
                }
            })();
        }

        // 在載入時檢查是否有儲存的資料
        function loadSavedData() {
            const savedData = localStorage.getItem('budgetData');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    const lastModified = localStorage.getItem('budgetLastModified');
                    
                    if (confirm(`發現本地儲存的修改資料（最後修改：${new Date(lastModified).toLocaleString()}）\n要載入這些資料嗎？`)) {
                        budgetData = parsed;
                        updatePageWithData();
                        console.log('✓ 已載入本地儲存的資料');
                    }
                } catch (e) {
                    console.error('載入本地資料失敗:', e);
                }
            }
        }
    </script>
</body>
</html>
