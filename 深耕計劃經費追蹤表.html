<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深耕計劃經費追蹤表</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 0 auto;
            max-width: 1400px;
        }

        .header-section {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .content-section {
            padding: 30px;
        }

        .return-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .summary-card h5 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card .percentage {
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .table-title {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
        }

        .budget-table {
            width: 100%;
            font-size: 0.85rem;
        }

        .budget-table th {
            background: #e9ecef;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
            border: 2px solid #dee2e6;
            padding: 8px;
            white-space: nowrap;
        }

        .budget-table td {
            text-align: right;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            white-space: nowrap;
        }

        .category-header {
            background: #6c757d !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
        }

        .subcategory-header {
            background: #adb5bd !important;
            font-weight: bold;
            text-align: left;
        }

        .amount-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .total-row {
            background: #fff3cd !important;
            font-weight: bold;
        }

        .progress-row {
            background: #d1ecf1 !important;
            font-weight: bold;
            color: #0c5460;
        }

        .percentage-cell {
            color: #28a745;
            font-weight: bold;
        }

        .section-divider {
            height: 3px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            margin: 30px 0;
            border-radius: 2px;
        }

        .progress-summary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-summary h4 {
            color: #8b4513;
            margin-bottom: 15px;
        }

        .progress-bars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .progress-item {
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 8px;
        }

        .progress-item h6 {
            margin-bottom: 8px;
            color: #5a3818;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-bar-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .budget-table {
                font-size: 0.7rem;
            }
            
            .budget-table th,
            .budget-table td {
                padding: 4px;
            }
            
            .header-section h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- 返回按鈕 -->
    <button class="btn btn-primary return-button" onclick="window.close()">
        <i class="fas fa-arrow-left me-1"></i>返回
    </button>

    <div class="container-fluid">
        <div class="main-container">
            <!-- 標題區 -->
            <div class="header-section">
                <h1><i class="fas fa-chart-line me-3"></i>深耕計劃經費追蹤表</h1>
                <p class="mb-0 fs-5">Deep Roots Program Budget Tracking</p>
            </div>

            <div class="content-section">
                <!-- 總覽卡片 -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <h5>總補助款 (A)</h5>
                        <div class="amount" id="cardTotalSubsidy">-</div>
                        <div class="percentage">申請金額</div>
                    </div>
                    <div class="summary-card">
                        <h5>總配合款 (F)</h5>
                        <div class="amount" id="cardTotalMatching">-</div>
                        <div class="percentage">配合款</div>
                    </div>
                    <div class="summary-card">
                        <h5>總經費 (G)</h5>
                        <div class="amount" id="cardTotal">-</div>
                        <div class="percentage">A + F</div>
                    </div>
                    <div class="summary-card">
                        <h5>資本門比例</h5>
                        <div class="amount" id="cardCapitalRatio">-</div>
                        <div class="percentage">占補助款</div>
                    </div>
                </div>

                <!-- 申請數據表 -->
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-file-invoice-dollar me-2"></i>申請數 - 第一階段
                    </div>
                    <div class="table-responsive">
                        <table class="table budget-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">範疇</th>
                                    <th colspan="2">範疇一</th>
                                    <th colspan="2">範疇二</th>
                                    <th colspan="2">範疇三</th>
                                    <th colspan="2">範疇四</th>
                                    <th colspan="3">總計(G)</th>
                                    <th colspan="2">配合款(F)</th>
                                </tr>
                                <tr>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款(A)</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td rowspan="4" class="subcategory-header">申請數<br>第一階段</td>
                                    <td class="amount-cell scope1-subsidy">-</td>
                                    <td class="amount-cell scope1-matching">-</td>
                                    <td class="amount-cell scope2-subsidy">-</td>
                                    <td class="amount-cell scope2-matching">-</td>
                                    <td class="amount-cell scope3-subsidy">-</td>
                                    <td class="amount-cell scope3-matching">-</td>
                                    <td class="amount-cell scope4-subsidy">-</td>
                                    <td class="amount-cell scope4-matching">-</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="subcategory-header">人事費</td>
                                    <td class="amount-cell">29,162,600</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="amount-cell">335,000</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td></td>
                                    <td class="subcategory-header">業務費</td>
                                    <td class="amount-cell">9,337,400</td>
                                    <td></td>
                                    <td class="amount-cell">1,490,000</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td></td>
                                    <td class="amount-cell">16,500,000</td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="amount-cell">4,000,000</td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="8"></td>
                                    <td class="amount-cell" id="totalSubsidyCell">-</td>
                                    <td></td>
                                    <td class="amount-cell" id="totalMatchingCell">-</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="9"></td>
                                    <td class="amount-cell" id="totalCell">-</td>
                                    <td colspan="4"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- 執行進度表 -->
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-chart-bar me-2"></i>執行進度 - 目前狀況
                    </div>
                    <div class="table-responsive">
                        <table class="table budget-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">範疇</th>
                                    <th colspan="2">範疇一</th>
                                    <th colspan="2">範疇二</th>
                                    <th colspan="2">範疇三</th>
                                    <th colspan="2">範疇四</th>
                                    <th colspan="3">總計(G)</th>
                                    <th colspan="2">配合款(F)</th>
                                </tr>
                                <tr>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款(A)</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                    <th>項目</th>
                                    <th>金額</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td rowspan="4" class="subcategory-header">執行數<br>第一階段</td>
                                    <td class="amount-cell exec-scope1-subsidy">-</td>
                                    <td class="amount-cell exec-scope1-matching">-</td>
                                    <td class="amount-cell exec-scope2-subsidy">-</td>
                                    <td class="amount-cell exec-scope2-matching">-</td>
                                    <td class="amount-cell exec-scope3-subsidy">-</td>
                                    <td class="amount-cell exec-scope3-matching">-</td>
                                    <td class="amount-cell exec-scope4-subsidy">-</td>
                                    <td class="amount-cell exec-scope4-matching">-</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="subcategory-header">人事費</td>
                                    <td class="amount-cell">541,503</td>
                                    <td class="subcategory-header">經常門</td>
                                    <td class="amount-cell">0</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td></td>
                                    <td class="subcategory-header">業務費</td>
                                    <td class="amount-cell">493,800</td>
                                    <td></td>
                                    <td class="amount-cell">0</td>
                                </tr>
                                <tr>
                                    <td colspan="8"></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td></td>
                                    <td class="amount-cell">5,760</td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="amount-cell">0</td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="8"></td>
                                    <td class="amount-cell" id="execTotalSubsidyCell">-</td>
                                    <td></td>
                                    <td class="amount-cell" id="execTotalMatchingCell">-</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="9"></td>
                                    <td class="amount-cell" id="execTotalCell">-</td>
                                    <td colspan="4"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 進度百分比表 -->
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-percentage me-2"></i>執行進度百分比
                    </div>
                    <div class="table-responsive">
                        <table class="table budget-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">項目</th>
                                    <th colspan="2">範疇一</th>
                                    <th colspan="2">範疇二</th>
                                    <th colspan="2">範疇三</th>
                                    <th colspan="2">範疇四</th>
                                    <th colspan="3">總計執行率</th>
                                    <th colspan="2">配合款執行率</th>
                                </tr>
                                <tr>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>補助款</th>
                                    <th>配合款</th>
                                    <th>項目</th>
                                    <th>執行率</th>
                                    <th>整體</th>
                                    <th>項目</th>
                                    <th>執行率</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="progress-row">
                                    <td class="subcategory-header">進度</td>
                                    <td class="percentage-cell">8.60%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">0.26%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="percentage-cell">19.44%</td>
                                    <td class="percentage-cell">0%</td>
                                    <td class="subcategory-header">經常門人事費</td>
                                    <td class="percentage-cell">1.86%</td>
                                    <td class="percentage-cell">1.71%</td>
                                    <td class="subcategory-header">經常門人事費</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                                <tr class="progress-row">
                                    <td colspan="9"></td>
                                    <td class="subcategory-header">經常門業務費</td>
                                    <td class="percentage-cell">5.29%</td>
                                    <td></td>
                                    <td class="subcategory-header">經常門業務費</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                                <tr class="progress-row">
                                    <td colspan="9"></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="percentage-cell">0.03%</td>
                                    <td></td>
                                    <td class="subcategory-header">資本門</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                                <tr class="progress-row">
                                    <td colspan="9"></td>
                                    <td class="subcategory-header">整體進度</td>
                                    <td class="percentage-cell">1.89%</td>
                                    <td></td>
                                    <td class="subcategory-header">整體進度</td>
                                    <td class="percentage-cell">0%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 視覺化進度摘要 -->
                <div class="progress-summary">
                    <h4><i class="fas fa-chart-pie me-2"></i>執行進度視覺化</h4>
                    <div class="progress-bars">
                        <div class="progress-item">
                            <h6>範疇一執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 8.6%"></div>
                            </div>
                            <small>8.60% (1,290,012 / 15,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>範疇二執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 0.26%"></div>
                            </div>
                            <small>0.26% (26,400 / 10,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>範疇三執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                            <small>0% (0 / 20,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>範疇四執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 19.44%"></div>
                            </div>
                            <small>19.44% (1,943,520 / 10,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>整體執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 1.89%"></div>
                            </div>
                            <small>1.89% (1,041,063 / 55,000,000)</small>
                        </div>
                        
                        <div class="progress-item">
                            <h6>配合款執行率</h6>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                            <small>0% (0 / 5,825,000)</small>
                        </div>
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="text-center mt-4">
                    <button class="btn btn-info btn-lg me-3" onclick="printReport()">
                        <i class="fas fa-print me-2"></i>列印報表
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" onclick="window.open('指標.html', '_blank')">
                        <i class="fas fa-chart-bar me-2"></i>返回指標頁面
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Google Sheets API 設定
        const SHEET_ID = '1x32_JhOr0BTeoiS3gaw48Le8mJtiwd597DOjKyInoeU';
        const SHEET_GID = '687531515'; // 深耕計劃經費追蹤表
        
        // 資料結構
        let budgetData = {
            // 申請數資料（Row 2）
            request: {
                scope1Subsidy: 15000000,
                scope1Matching: 700000,
                scope2Subsidy: 10000000,
                scope2Matching: 250000,
                scope3Subsidy: 20000000,
                scope3Matching: 3200000,
                scope4Subsidy: 10000000,
                scope4Matching: 1675000,
                permanentStaff: 29162600,
                permanentBusiness: 9337400,
                capital: 16500000,
                permanentMatchingStaff: 335000,
                permanentMatchingBusiness: 1490000,
                capitalMatching: 4000000,
                totalSubsidy: 55000000,
                totalMatching: 5825000,
                total: 60825000,
                capitalRatio: 30
            },
            // 執行數資料（Row 15）
            execution: {
                scope1Subsidy: 1290012,
                scope1Matching: 0,
                scope2Subsidy: 26400,
                scope2Matching: 0,
                scope3Subsidy: 0,
                scope3Matching: 0,
                scope4Subsidy: 1943520,
                scope4Matching: 0,
                permanentStaff: 541503,
                permanentBusiness: 493800,
                capital: 5760,
                permanentMatchingStaff: 0,
                permanentMatchingBusiness: 0,
                capitalMatching: 0,
                totalSubsidy: 1041063,
                totalMatching: 0,
                total: 1041063
            },
            // 執行率（Row 25 和其他）
            rate: {
                scope1: 8.6,
                scope2: 0.264,
                scope3: 0,
                scope4: 19.44,
                permanentStaff: 1.86,
                permanentBusiness: 5.29,
                capital: 0.03,
                total: 1.89,
                matchingTotal: 0
            }
        };

        // 從 CSV 載入資料
        async function loadBudgetDataFromSheet() {
            try {
                const contentSection = document.querySelector('.content-section');
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'alert alert-info';
                loadingMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在載入經費資料...';
                contentSection.prepend(loadingMessage);

                const API_KEY = 'AIzaSyA0JKp0Y8ZmGDHcPEmf4ncaWvnTMtoa8KM';
                const range = encodeURIComponent('深耕計劃經費追蹤表!A1:O30');
                
                // 添加時間戳避免快取
                const timestamp = new Date().getTime();
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}&t=${timestamp}`;
                
                console.log('正在從 Google Sheets API 載入資料...', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API 錯誤 ${response.status}`);
                }
                
                const data = await response.json();
                const rows = data.values || [];
                
                console.log(`✓ 成功載入 ${rows.length} 列資料`);
                console.log('第一列:', rows[0]);
                console.log('第二列:', rows[1]);
                console.log('第三列:', rows[2]);
                
                // 解析資料
                parseSheetData(rows);
                
                // 更新頁面
                updatePageWithData();
                
                loadingMessage.remove();
                
                console.log('✓ 經費資料已成功載入並更新');
            } catch (error) {
                console.error('❌ 載入經費資料失敗:', error);
                
                // 如果 API 載入失敗，嘗試使用備用資料或通知使用者
                showErrorMessage(error.message);
            }
        }

        // 顯示錯誤訊息並提供使用者指引
        function showErrorMessage(errorMsg) {
            const contentSection = document.querySelector('.content-section');
            const loadingMsg = contentSection.querySelector('.alert-info');
            if (loadingMsg) loadingMsg.remove();
            
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-warning alert-dismissible fade show';
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>資料載入提示</strong><br>
                <small>目前無法即時載入 Google Sheets 資料，頁面顯示預設資料。<br>
                如需更新，請按 F5 刷新頁面或點擊下方「重新載入資料」按鈕。</small>
                <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">重新載入資料</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            contentSection.prepend(errorMessage);
            
            // 保留預設資料顯示
            updatePageWithData();
        }

        // 解析 CSV 資料
        function parseSheetData(rows) {
            try {
                console.log('開始解析資料...');
                
                if (rows.length < 3) {
                    console.warn('⚠️ 資料不足，使用預設值');
                    return;
                }
                
                const parseNum = (str) => {
                    if (!str) return 0;
                    // 處理各種數字格式：15000000, "15,000,000", "15 000 000" 等
                    const cleaned = String(str).replace(/[,\s"]/g, '');
                    return parseInt(cleaned) || 0;
                };
                
                // 資料結構：
                // R0: 標題 [範疇, , 範疇一, , 範疇二, , 範疇三, , 範疇四, , 總計(G), , , , ]
                // R1: 子標題 [申請數, 第一階段, 補助款, 配合款, ...]
                // R2: 申請數資料
                
                console.log('R2 欄位:', rows[2]);
                
                // 解析申請數（R2）
                // 欄位位置：C0=空, C1=空, C2=範疇一補助, C3=範疇一配合, C4=範疇二補助...
                if (rows[2] && rows[2].length >= 11) {
                    const req = rows[2];
                    
                    budgetData.request.scope1Subsidy = parseNum(req[2]);
                    budgetData.request.scope1Matching = parseNum(req[3]);
                    budgetData.request.scope2Subsidy = parseNum(req[4]);
                    budgetData.request.scope2Matching = parseNum(req[5]);
                    budgetData.request.scope3Subsidy = parseNum(req[6]);
                    budgetData.request.scope3Matching = parseNum(req[7]);
                    budgetData.request.scope4Subsidy = parseNum(req[8]);
                    budgetData.request.scope4Matching = parseNum(req[9]);
                    
                    console.log('✓ 申請數解析:', {
                        scope1Subsidy: budgetData.request.scope1Subsidy,
                        scope2Subsidy: budgetData.request.scope2Subsidy
                    });
                }
                
                // 解析總補助款（R5, C10）
                if (rows[5] && rows[5][10] !== undefined) {
                    budgetData.request.totalSubsidy = parseNum(rows[5][10]);
                    console.log('✓ 總補助款:', budgetData.request.totalSubsidy);
                }
                
                // 解析總經費（R6, C10）
                if (rows[6] && rows[6][10] !== undefined) {
                    budgetData.request.total = parseNum(rows[6][10]);
                    console.log('✓ 總經費:', budgetData.request.total);
                }
                
                // 計算配合款
                if (budgetData.request.totalSubsidy > 0 && budgetData.request.total > 0) {
                    budgetData.request.totalMatching = budgetData.request.total - budgetData.request.totalSubsidy;
                    console.log('✓ 配合款:', budgetData.request.totalMatching);
                }
                
                // 資本門比例 (R9, C10)
                if (rows[9] && rows[9][10]) {
                    budgetData.request.capitalRatio = parseFloat(String(rows[9][10]).replace('%', '')) || 30;
                    console.log('✓ 資本門比例:', budgetData.request.capitalRatio + '%');
                }
                
                // 查找執行數資料的起始列（通常標記為「執行數」）
                let executionRowIdx = -1;
                for (let i = 10; i < rows.length; i++) {
                    if (rows[i][0] && String(rows[i][0]).includes('執行')) {
                        executionRowIdx = i;
                        break;
                    }
                }
                
                console.log('執行數資料列索引:', executionRowIdx);
                
                // 解析執行數（通常在找到「執行數」標籤後的下一列）
                if (executionRowIdx > 0 && rows[executionRowIdx + 1]) {
                    const exec = rows[executionRowIdx + 1];
                    if (exec.length >= 11) {
                        budgetData.execution.scope1Subsidy = parseNum(exec[2]);
                        budgetData.execution.scope1Matching = parseNum(exec[3]);
                        budgetData.execution.scope2Subsidy = parseNum(exec[4]);
                        budgetData.execution.scope2Matching = parseNum(exec[5]);
                        budgetData.execution.scope3Subsidy = parseNum(exec[6]);
                        budgetData.execution.scope3Matching = parseNum(exec[7]);
                        budgetData.execution.scope4Subsidy = parseNum(exec[8]);
                        budgetData.execution.scope4Matching = parseNum(exec[9]);
                        budgetData.execution.totalSubsidy = parseNum(exec[10]);
                        
                        console.log('✓ 執行數解析:', {
                            scope1Subsidy: budgetData.execution.scope1Subsidy,
                            totalSubsidy: budgetData.execution.totalSubsidy
                        });
                    }
                }
                
                // 計算執行率
                budgetData.rate.scope1 = budgetData.request.scope1Subsidy > 0 
                    ? (budgetData.execution.scope1Subsidy / budgetData.request.scope1Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.scope2 = budgetData.request.scope2Subsidy > 0 
                    ? (budgetData.execution.scope2Subsidy / budgetData.request.scope2Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.scope3 = budgetData.request.scope3Subsidy > 0 
                    ? (budgetData.execution.scope3Subsidy / budgetData.request.scope3Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.scope4 = budgetData.request.scope4Subsidy > 0 
                    ? (budgetData.execution.scope4Subsidy / budgetData.request.scope4Subsidy * 100).toFixed(2)
                    : 0;
                budgetData.rate.total = budgetData.request.totalSubsidy > 0 
                    ? (budgetData.execution.totalSubsidy / budgetData.request.totalSubsidy * 100).toFixed(2)
                    : 0;
                
                console.log('✓ 資料解析完成:', budgetData);
                
            } catch (e) {
                console.error('資料解析錯誤:', e);
                console.error('堆棧:', e.stack);
            }
        }

        // 更新頁面顯示
        function updatePageWithData() {
            // 格式化數字
            const fmt = (num) => Math.round(num).toLocaleString('en-US');
            
            console.log('開始更新頁面，budgetData:', budgetData);
            
            // 更新卡片（用 ID 選擇器）
            const el = {
                cardTotalSubsidy: document.getElementById('cardTotalSubsidy'),
                cardTotalMatching: document.getElementById('cardTotalMatching'),
                cardTotal: document.getElementById('cardTotal'),
                cardCapitalRatio: document.getElementById('cardCapitalRatio'),
                totalSubsidyCell: document.getElementById('totalSubsidyCell'),
                totalMatchingCell: document.getElementById('totalMatchingCell'),
                totalCell: document.getElementById('totalCell'),
                execTotalSubsidyCell: document.getElementById('execTotalSubsidyCell'),
                execTotalMatchingCell: document.getElementById('execTotalMatchingCell'),
                execTotalCell: document.getElementById('execTotalCell')
            };
            
            if (el.cardTotalSubsidy) el.cardTotalSubsidy.textContent = budgetData.request.totalSubsidy > 0 ? fmt(budgetData.request.totalSubsidy) : '-';
            if (el.cardTotalMatching) el.cardTotalMatching.textContent = budgetData.request.totalMatching > 0 ? fmt(budgetData.request.totalMatching) : '-';
            if (el.cardTotal) el.cardTotal.textContent = budgetData.request.total > 0 ? fmt(budgetData.request.total) : '-';
            if (el.cardCapitalRatio) el.cardCapitalRatio.textContent = budgetData.request.capitalRatio > 0 ? budgetData.request.capitalRatio + '%' : '-';
            
            // 更新小計欄位
            if (el.totalSubsidyCell) el.totalSubsidyCell.textContent = budgetData.request.totalSubsidy > 0 ? fmt(budgetData.request.totalSubsidy) : '-';
            if (el.totalMatchingCell) el.totalMatchingCell.textContent = budgetData.request.totalMatching > 0 ? fmt(budgetData.request.totalMatching) : '-';
            if (el.totalCell) el.totalCell.textContent = budgetData.request.total > 0 ? fmt(budgetData.request.total) : '-';
            if (el.execTotalSubsidyCell) el.execTotalSubsidyCell.textContent = budgetData.execution.totalSubsidy > 0 ? fmt(budgetData.execution.totalSubsidy) : '-';
            if (el.execTotalMatchingCell) el.execTotalMatchingCell.textContent = budgetData.execution.totalMatching > 0 ? fmt(budgetData.execution.totalMatching) : '-';
            if (el.execTotalCell) el.execTotalCell.textContent = budgetData.execution.total > 0 ? fmt(budgetData.execution.total) : '-';
            
            console.log('卡片已更新');
            
            // 更新申請數表格
            updateRequestTable();
            
            // 更新執行數表格
            updateExecutionTable();
            
            // 更新進度百分比表
            updateRateTable();
            
            // 更新進度條
            updateProgressBars();
            
            console.log('✓ 頁面已完全更新');
        }

        // 更新申請數表格
        function updateRequestTable() {
            const fmt = (num) => Math.round(num).toLocaleString('en-US');
            
            // 用 class 選擇器直接更新
            const cells = {
                scope1Subsidy: document.querySelector('.scope1-subsidy'),
                scope1Matching: document.querySelector('.scope1-matching'),
                scope2Subsidy: document.querySelector('.scope2-subsidy'),
                scope2Matching: document.querySelector('.scope2-matching'),
                scope3Subsidy: document.querySelector('.scope3-subsidy'),
                scope3Matching: document.querySelector('.scope3-matching'),
                scope4Subsidy: document.querySelector('.scope4-subsidy'),
                scope4Matching: document.querySelector('.scope4-matching')
            };
            
            if (cells.scope1Subsidy) cells.scope1Subsidy.textContent = budgetData.request.scope1Subsidy > 0 ? fmt(budgetData.request.scope1Subsidy) : '-';
            if (cells.scope1Matching) cells.scope1Matching.textContent = budgetData.request.scope1Matching > 0 ? fmt(budgetData.request.scope1Matching) : '-';
            if (cells.scope2Subsidy) cells.scope2Subsidy.textContent = budgetData.request.scope2Subsidy > 0 ? fmt(budgetData.request.scope2Subsidy) : '-';
            if (cells.scope2Matching) cells.scope2Matching.textContent = budgetData.request.scope2Matching > 0 ? fmt(budgetData.request.scope2Matching) : '-';
            if (cells.scope3Subsidy) cells.scope3Subsidy.textContent = budgetData.request.scope3Subsidy > 0 ? fmt(budgetData.request.scope3Subsidy) : '-';
            if (cells.scope3Matching) cells.scope3Matching.textContent = budgetData.request.scope3Matching > 0 ? fmt(budgetData.request.scope3Matching) : '-';
            if (cells.scope4Subsidy) cells.scope4Subsidy.textContent = budgetData.request.scope4Subsidy > 0 ? fmt(budgetData.request.scope4Subsidy) : '-';
            if (cells.scope4Matching) cells.scope4Matching.textContent = budgetData.request.scope4Matching > 0 ? fmt(budgetData.request.scope4Matching) : '-';
            
            console.log('✓ 申請數表格已更新');
        }

        // 更新執行數表格
        function updateExecutionTable() {
            const fmt = (num) => Math.round(num).toLocaleString('en-US');
            
            const cells = {
                scope1Subsidy: document.querySelector('.exec-scope1-subsidy'),
                scope1Matching: document.querySelector('.exec-scope1-matching'),
                scope2Subsidy: document.querySelector('.exec-scope2-subsidy'),
                scope2Matching: document.querySelector('.exec-scope2-matching'),
                scope3Subsidy: document.querySelector('.exec-scope3-subsidy'),
                scope3Matching: document.querySelector('.exec-scope3-matching'),
                scope4Subsidy: document.querySelector('.exec-scope4-subsidy'),
                scope4Matching: document.querySelector('.exec-scope4-matching')
            };
            
            if (cells.scope1Subsidy) cells.scope1Subsidy.textContent = budgetData.execution.scope1Subsidy > 0 ? fmt(budgetData.execution.scope1Subsidy) : '-';
            if (cells.scope1Matching) cells.scope1Matching.textContent = budgetData.execution.scope1Matching > 0 ? fmt(budgetData.execution.scope1Matching) : '-';
            if (cells.scope2Subsidy) cells.scope2Subsidy.textContent = budgetData.execution.scope2Subsidy > 0 ? fmt(budgetData.execution.scope2Subsidy) : '-';
            if (cells.scope2Matching) cells.scope2Matching.textContent = budgetData.execution.scope2Matching > 0 ? fmt(budgetData.execution.scope2Matching) : '-';
            if (cells.scope3Subsidy) cells.scope3Subsidy.textContent = budgetData.execution.scope3Subsidy > 0 ? fmt(budgetData.execution.scope3Subsidy) : '-';
            if (cells.scope3Matching) cells.scope3Matching.textContent = budgetData.execution.scope3Matching > 0 ? fmt(budgetData.execution.scope3Matching) : '-';
            if (cells.scope4Subsidy) cells.scope4Subsidy.textContent = budgetData.execution.scope4Subsidy > 0 ? fmt(budgetData.execution.scope4Subsidy) : '-';
            if (cells.scope4Matching) cells.scope4Matching.textContent = budgetData.execution.scope4Matching > 0 ? fmt(budgetData.execution.scope4Matching) : '-';
            
            console.log('✓ 執行數表格已更新');
        }

        // 更新進度百分比表
        function updateRateTable() {
            const tables = document.querySelectorAll('.budget-table');
            if (tables.length > 2) {
                const thirdTable = tables[2];
                const rows = thirdTable.querySelectorAll('tbody tr');
                
                if (rows.length > 0) {
                    const firstDataRow = rows[0];
                    const cells = firstDataRow.querySelectorAll('td.percentage-cell');
                    
                    if (cells.length >= 8) {
                        cells[0].textContent = budgetData.rate.scope1 + '%';
                        cells[1].textContent = '0%'; // 配合款
                        cells[2].textContent = budgetData.rate.scope2 + '%';
                        cells[3].textContent = '0%'; // 配合款
                        cells[4].textContent = budgetData.rate.scope3 + '%';
                        cells[5].textContent = '0%'; // 配合款
                        cells[6].textContent = budgetData.rate.scope4 + '%';
                        cells[7].textContent = '0%'; // 配合款
                        
                        console.log('✓ 執行率表格已更新');
                    }
                }
            }
        }

        // 更新進度條
        function updateProgressBars() {
            const items = [
                { selector: '[style*="width: 8.6%"]', rate: budgetData.rate.scope1, label: `${budgetData.rate.scope1}% (${budgetData.execution.scope1Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope1Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 0.26%"]', rate: budgetData.rate.scope2, label: `${budgetData.rate.scope2}% (${budgetData.execution.scope2Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope2Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 0%"]', rate: budgetData.rate.scope3, label: `${budgetData.rate.scope3}% (${budgetData.execution.scope3Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope3Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 19.44%"]', rate: budgetData.rate.scope4, label: `${budgetData.rate.scope4}% (${budgetData.execution.scope4Subsidy.toLocaleString('en-US')} / ${budgetData.request.scope4Subsidy.toLocaleString('en-US')})` },
                { selector: '[style*="width: 1.89%"]', rate: budgetData.rate.total, label: `${budgetData.rate.total}% (${budgetData.execution.totalSubsidy.toLocaleString('en-US')} / ${budgetData.request.totalSubsidy.toLocaleString('en-US')})` }
            ];
            
            const progressBars = document.querySelectorAll('.progress-bar-fill');
            progressBars.forEach((bar, idx) => {
                if (idx < items.length) {
                    const rate = Math.min(items[idx].rate, 100);
                    bar.style.width = rate + '%';
                }
            });
            
            const smallTexts = document.querySelectorAll('.progress-item small');
            smallTexts.forEach((text, idx) => {
                if (idx < items.length) {
                    text.textContent = items[idx].label;
                }
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded: 開始載入經費資料...');
            
            // 先顯示預設資料（立即可見）
            updatePageWithData();
            
            // 異步載入 Google Sheets 資料（如果成功則覆蓋預設值）
            setTimeout(() => {
                loadBudgetDataFromSheet();
            }, 500);
        });

        function printReport() {
            window.print();
        }

        function showUpdateReminder() {
            const lastUpdate = localStorage.getItem('budgetLastUpdate');
            const now = new Date().getTime();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;
            
            if (!lastUpdate || now - lastUpdate > oneWeek) {
                const reminder = document.createElement('div');
                reminder.className = 'alert alert-warning alert-dismissible fade show';
                reminder.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    提醒：建議定期更新經費追蹤數據以確保資訊準確性
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.content-section').prepend(reminder);
            }
        }

        window.onload = function() {
            showUpdateReminder();
            console.log('深耕計劃經費追蹤表載入完成');
        };
    </script>
</body>
</html>
