# 解決 401 錯誤 - 快速指南

## 問題原因
❌ **Google Sheets API 的 API Key 無法執行寫入操作 (PUT/POST)**
- API Key 只能用於**唯讀操作** (GET)
- 寫入操作需要 OAuth 2.0 或 Apps Script

## 解決方案：使用 Google Apps Script

### 第 1 步：開啟 Apps Script 編輯器
1. 開啟你的 Google Sheet：
   ```
   https://docs.google.com/spreadsheets/d/1x32_JhOr0BTeoiS3gaw48Le8mJtiwd597DOjKyInoeU/edit
   ```

2. 點擊上方選單：**擴充功能** → **Apps Script**

### 第 2 步：貼上程式碼
刪除預設的 `myFunction()`，貼上以下完整程式碼：

```javascript
function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('個案管理');
  
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({
      error: '找不到「個案管理」工作表'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1);
  
  const cases = rows.map(row => {
    let obj = {};
    headers.forEach((header, index) => {
      obj[header] = row[index];
    });
    return obj;
  });
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    data: cases
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('個案管理');
    
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: '找不到「個案管理」工作表'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const postData = JSON.parse(e.postData.contents);
    const action = postData.action;
    
    if (action === 'sync') {
      const cases = postData.cases;
      
      // 清除現有資料（保留標題列）
      const lastRow = sheet.getLastRow();
      if (lastRow > 1) {
        sheet.getRange(2, 1, lastRow - 1, 9).clearContent();
      }
      
      // 寫入新資料
      if (cases && cases.length > 0) {
        const values = cases.map(c => [
          c.id,
          c.name,
          c.type,
          c.condition,
          c.admissionDate,
          c.reviewDate,
          c.finalReviewDate,
          c.dischargeDate,
          JSON.stringify(c.status)
        ]);
        
        sheet.getRange(2, 1, values.length, 9).setValues(values);
      }
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        message: `成功同步 ${cases.length} 筆資料`
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: '未知的操作'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
```

### 第 3 步：部署為 Web 應用程式
1. 點擊右上角 **「部署」** → **「新增部署作業」**

2. 點擊齒輪圖示 → 選擇 **「網頁應用程式」**

3. 填寫設定：
   - **說明**：`個案管理 API v1`
   - **執行身分**：**我**
   - **具有應用程式存取權的使用者**：**所有人** ⚠️ 重要！

4. 點擊 **「部署」**

5. 第一次會要求授權：
   - 點擊「審查權限」
   - 選擇你的 Google 帳號
   - 點擊「進階」→「前往專案（不安全）」
   - 點擊「允許」

6. **複製網頁應用程式網址**（類似這樣）：
   ```
   https://script.google.com/macros/s/AKfycby.../exec
   ```

### 第 4 步：更新 HTML 設定
開啟 `AI個案管理名單.html`，找到：
```javascript
const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE';
```

替換為你複製的網址：
```javascript
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby.../exec';
```

### 第 5 步：測試
1. 儲存 HTML 檔案
2. 重新整理頁面
3. 應該可以看到資料載入
4. 嘗試新增/編輯/刪除個案，檢查是否同步到 Google Sheets

## 驗證 Apps Script 是否正常運作
在瀏覽器直接訪問你的 Apps Script URL：
```
https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec
```

應該會返回 JSON 格式的資料，例如：
```json
{
  "success": true,
  "data": [...]
}
```

## 常見問題

**Q: 顯示「需要授權」？**
- A: 在部署步驟 3 確認選擇了「所有人」

**Q: 如何更新 Apps Script 程式碼？**
- A: 修改後，點擊「部署」→「管理部署作業」→ 編輯 → 新版本 → 部署

**Q: 還是無法寫入？**
- A: 檢查工作表名稱是否為「個案管理」（不是 "Sheet1"）

## 相關檔案
- 完整設定指南：`GOOGLE_APPS_SCRIPT_SETUP.md`
- HTML 檔案：`AI個案管理名單.html`
